/**
 * skylark-formio - A version of formio.js that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-formio/
 * @license MIT
 */
define(["skylark-lodash","skylark-moment","./EventEmitter","skylark-i18next","./Formio","./vendors/getify/npo","./components/Components","./components/_classes/nesteddata/NestedDataComponent","./utils/utils","./utils/formUtils","./i18n"],function(t,s,e,i,o,n,r,a,h,m,u){"use strict";o.forms={},o.registerComponent=r.setComponent;class l extends a{constructor(){let s,r;arguments[0]instanceof HTMLElement||arguments[1]?(s=arguments[0],r=arguments[1]):r=arguments[0],super(null,function(s){var n;return(s=t.defaults(s,{submitOnEnter:!1,iconset:(n=s&&s.icons?s.icons:o.icons,"fontawesome"===n?"fa":n||""),i18next:i,saveDraft:!1,alwaysDirty:!1,saveDraftThrottle:5e3})).events||(s.events=new e({wildcard:!1,maxListeners:0})),s}(r)),this.element=s,o.forms[this.id]=this,this.options.baseUrl&&o.setBaseUrl(this.options.baseUrl),r&&r.i18n&&!r.i18nReady&&(r.i18n.resources?u=r.i18n:t.each(r.i18n,(s,e)=>{"options"===e?t.merge(u,s):u.resources[e]?t.assign(u.resources[e].translation,s):u.resources[e]={translation:s}}),r.i18n=u,r.i18nReady=!0),r&&r.i18n?this.options.i18n=r.i18n:this.options.i18n=u,this.options.language&&(this.options.i18n.lng=this.options.language),this.type="form",this._src="",this._loading=!1,this._form={},this.draftEnabled=!1,this.savingDraft=!0,this.options.saveDraftThrottle?this.triggerSaveDraft=t.throttle(this.saveDraft.bind(this),this.options.saveDraftThrottle):this.triggerSaveDraft=this.saveDraft.bind(this),this.customErrors=[],this.nosubmit=!1,this.submitted=!1,this.submitting=!1,this.formio=null,this.loader=null,this.alert=null,this.onSubmission=null,this.submissionSet=!1,this.formReady=new n((t,s)=>{this.formReadyResolve=t,this.formReadyReject=s}),this.submissionReady=new n((t,s)=>{this.submissionReadyResolve=t,this.submissionReadyReject=s}),this.shortcuts=[],this.localize().then(()=>{this.language=this.options.language}),this.options.saveDraft&&o.events&&o.events.on("formio.user",t=>{this.formReady.then(()=>{this.submissionSet||this.restoreDraft(t._id)})}),this.component.clearOnHide=!1,this.root=this}set language(t){return new n((s,e)=>{if(this.options.language=t,i.language===t)return s();try{i.changeLanguage(t,t=>{if(t)return e(t);this.redraw(),this.emit("languageChanged"),s()})}catch(t){return e(t)}})}addLanguage(t,s,e=!1){i.addResourceBundle(t,"translation",s,!0,!0),e&&(this.language=t)}localize(){return i.initialized?n.resolve(i):(i.initialized=!0,new n((t,s)=>{try{i.init(this.options.i18n,e=>{if(this.options.language=i.language.split(";")[0],e)return s(e);t(i)})}catch(t){return s(t)}}))}keyboardCatchableElement(t){return"TEXTAREA"!==t.nodeName&&("INPUT"!==t.nodeName||-1===["text","email","password"].indexOf(t.type))}executeShortcuts(s){const{target:e}=s;if(!this.keyboardCatchableElement(e))return;const i=s.ctrlKey||s.metaKey,o=s.keyCode;let n="";65<=o&&o<=90?n=String.fromCharCode(o):13===o?n="Enter":27===o&&(n="Esc"),t.each(this.shortcuts,t=>{t.ctrl&&!i||t.shortcut===n&&(t.element.click(),s.preventDefault())})}addShortcut(s,e){if(e&&/^([A-Z]|Enter|Esc)$/i.test(e))if("Enter"===(e=t.capitalize(e))||"Esc"===e){if("BUTTON"!==s.tagName)return;this.shortcuts.push({shortcut:e,element:s})}else this.shortcuts.push({ctrl:!0,shortcut:e,element:s})}removeShortcut(s,e){e&&/^([A-Z]|Enter|Esc)$/i.test(e)&&t.remove(this.shortcuts,{shortcut:e,element:s})}get src(){return this._src}loadSubmission(){return this.loadingSubmission=!0,this.formio.submissionId?this.onSubmission=this.formio.loadSubmission().then(t=>this.setSubmission(t),t=>this.submissionReadyReject(t)).catch(t=>this.submissionReadyReject(t)):this.submissionReadyResolve(),this.submissionReady}setSrc(t,s){return this.setUrl(t,s)?(this.nosubmit=!1,this.formio.loadForm({params:{live:1}}).then(t=>{const s=this.setForm(t);return this.loadSubmission(),s}).catch(t=>{console.warn(t),this.formReadyReject(t)})):n.resolve()}set src(t){this.setSrc(t)}get url(){return this._src}setUrl(t,s){return!(!t||"string"!=typeof t||t===this._src)&&(this._src=t,this.nosubmit=!0,this.formio=this.options.formio=new o(t,s),"form"===this.type&&(this.options.src=t),!0)}set url(t){this.setUrl(t)}get ready(){return this.formReady.then(()=>super.ready.then(()=>!this.loadingSubmission||this.submissionReady))}get loading(){return this._loading}set loading(t){if(this._loading!==t){if(this._loading=t,!this.loader&&t){this.loader=this.ce("div",{class:"loader-wrapper"});const t=this.ce("div",{class:"loader text-center"});this.loader.appendChild(t)}if(this.loader)try{t?this.prependTo(this.loader,this.wrapper):this.removeChildFrom(this.loader,this.wrapper)}catch(t){}}}setForm(t){if(this._form=t,t&&t.settings&&t.settings.components&&(this.options.components=t.settings.components),t&&t.module){let s=null;if("string"==typeof t.module)try{s=this.evaluate(`return ${t.module}`)}catch(t){console.warn(t)}else s=t.module;s&&(o.use(s),s.options&&s.options.form&&(this.options=Object.assign(this.options,s.options.form)))}return this.initialized=!1,(this.rebuild()||n.resolve()).then(()=>(this.emit("formLoad",t),this.triggerRecaptcha(),setTimeout(()=>{this.onChange(),this.formReadyResolve()},0),this.formReady))}get form(){return this._form||(this._form={components:[]}),this._form}set form(t){this.setForm(t)}get submission(){return this.getValue()}set submission(t){this.setSubmission(t)}setSubmission(t,s={}){return s={...s,fromSubmission:!0},this.onSubmission=this.formReady.then(()=>(this.submissionSet=!0,this.triggerChange(s),this.setValue(t,s),this.submissionReadyResolve(t)),t=>this.submissionReadyReject(t)).catch(t=>this.submissionReadyReject(t))}saveDraft(){if(!this.draftEnabled)return;if(!this.formio)return void console.warn("Cannot save draft because there is no formio instance.");if(!o.getUser())return void console.warn("Cannot save draft unless a user is authenticated.");const s=this.submission;s.state="draft",this.savingDraft||(this.savingDraft=!0,this.formio.saveSubmission(s).then(e=>{const i=t.merge(e,s);this.emit("saveDraft",e),s._id?this.savingDraft=!1:this.setSubmission(i).then(()=>{this.savingDraft=!1})}))}restoreDraft(t){this.formio?(this.savingDraft=!0,this.formio.loadSubmissions({params:{state:"draft",owner:t}}).then(t=>{if(t.length>0&&!this.options.skipDraftRestore){const s=h.fastCloneDeep(t[0]);return this.setSubmission(s).then(()=>{this.draftEnabled=!0,this.savingDraft=!1,this.emit("restoreDraft",s)})}this.draftEnabled=!0,this.savingDraft=!1,this.emit("restoreDraft",null)})):console.warn("Cannot restore draft because there is no formio instance.")}get schema(){const s=h.fastCloneDeep(t.omit(this._form,["components"]));return s.components=[],this.eachComponent(t=>s.components.push(t.schema)),s}mergeData(s,e){t.mergeWith(s,e,(t,s)=>{if(Array.isArray(t)&&Array.isArray(s)&&t.length!==s.length)return s})}setValue(t,s={}){t&&t.data||(t={data:{}}),this._submission.metadata=t.metadata||{},this.editing=!!t._id,!this.options.submissionTimezone&&t.metadata&&t.metadata.timezone&&(this.options.submissionTimezone=t.metadata.timezone);const e=super.setValue(t.data,s);return s.sanitize||this.mergeData(this.data,t.data),t.data=this.data,this._submission=t,e}getValue(){if(this._submission.data||(this._submission.data={}),this.viewOnly)return this._submission;return this._submission.data=this.data,this._submission}init(){return this._submission=this._submission||{data:{}},this.components&&this.components.length&&(this.destroyComponents(),this.components=[]),this.component?this.component.components=this.form?this.form.components:[]:this.component=this.form,this.component.type="form",this.component.input=!1,this.addComponents(),this.on("submitButton",t=>{this.submit(!1,t).catch(t=>!1!==t&&console.log(t))},!0),this.on("checkValidity",t=>this.checkValidity(t,!0,t),!0),this.on("requestUrl",t=>this.submitUrl(t.url,t.headers),!0),this.on("resetForm",()=>this.resetValue(),!0),this.on("deleteSubmission",()=>this.deleteSubmission(),!0),this.on("refreshData",()=>this.updateValue(),!0),this.executeFormController(),this.formReady}executeFormController(){if(!this.form||!this.form.controller||(!this.visible||this.component.hidden)&&this.component.clearOnHide&&!this.rootPristine)return!1;this.formReady.then(()=>{this.evaluate(this.form.controller,{components:this.components})})}destroy(){return this.off("submitButton"),this.off("checkValidity"),this.off("requestUrl"),this.off("resetForm"),this.off("deleteSubmission"),this.off("refreshData"),super.destroy()}build(t){return t||this.element?this.ready.then(()=>{t=t||this.element,super.build(t)}):this.ready}getClassName(){return"formio-form"}render(){return super.render(this.renderTemplate("webform",{classes:this.getClassName(),children:this.renderComponents()}),this.builderMode?"builder":"form",!0)}redraw(){return this.element?(this.clear(),this.setContent(this.element,this.render()),this.attach(this.element)):n.resolve()}attach(t){this.element=t,this.loadRefs(t,{webform:"single"});const s=this.attachComponents(this.refs.webform);return this.addEventListener(this.element,"keydown",this.executeShortcuts),this.currentForm=this,s.then(()=>(this.emit("render"),this.setValue(this._submission,{noUpdateEvent:!0})))}hasRequiredFields(){let t=!1;return m.eachComponent(this.form.components,s=>{if(s.validate.required)return t=!0,!0},!0),t}resetValue(){t.each(this.getComponents(),t=>t.resetValue()),this.setPristine(!0)}setAlert(t,s){if(t||!this.submitted)if(this.options.noAlerts)s||this.emit("error",!1);else{if(this.alert)try{this.refs.errorRef&&this.refs.errorRef.length&&this.refs.errorRef.forEach(t=>{this.removeEventListener(t,"click"),this.removeEventListener(t,"keypress")}),this.removeChild(this.alert),this.alert=null}catch(t){}s&&(this.alert=this.ce("div",{id:`error-list-${this.id}`,class:`alert alert-${t}`,role:"alert"}),s instanceof HTMLElement?this.appendTo(s,this.alert):this.setContent(this.alert,s)),this.alert&&(this.loadRefs(this.alert,{errorRef:"multiple"}),this.refs.errorRef&&this.refs.errorRef.length&&this.refs.errorRef.forEach(t=>{this.addEventListener(t,"click",t=>{const s=t.currentTarget.dataset.componentKey;this.focusOnComponent(s)}),this.addEventListener(t,"keypress",t=>{if(13===t.keyCode){const s=t.currentTarget.dataset.componentKey;this.focusOnComponent(s)}})}),this.prepend(this.alert))}else this.alert&&(this.refs.errorRef&&this.refs.errorRef.length&&this.refs.errorRef.forEach(t=>{this.removeEventListener(t,"click"),this.removeEventListener(t,"keypress")}),this.removeChild(this.alert),this.alert=null)}focusOnComponent(t){if(t){const s=this.getComponent(t);s&&s.focus()}}showErrors(s,e){this.loading=!1;let i=this.errors;if(s?Array.isArray(s)?i=i.concat(s):i.push(s):i=super.errors,!(i=i.concat(this.customErrors)).length)return void this.setAlert(!1);i.forEach(s=>{const{components:e=[]}=s;s.component&&e.push(s.component),s.path&&e.push(s.path),e.forEach(e=>{const i=this.getComponent(e,t.identity);t.compact(Array.isArray(i)?i:[i]).forEach(t=>t.setCustomValidity(s.message,!0))})});const o=document.createDocumentFragment(),n=this.ce("p");this.setContent(n,this.t("error"));const r=this.ce("ul");return i.forEach(s=>{if(s){const e=t=>{const e={ref:"errorRef",tabIndex:0,"aria-label":`${t}. Click to navigate to the field with following error.`},i=this.ce("li",e);this.setContent(i,t),s.component&&s.component.key&&(i.dataset.componentKey=s.component.key),this.appendTo(i,r)};if(s.messages&&s.messages.length)s.messages.forEach(({message:t})=>e(`${this.t(s.component.label)}. ${t}`));else if(s){const i=t.isObject(s)?s.message||"":s;e(i)}}}),n.appendChild(r),o.appendChild(n),this.setAlert("danger",o),e&&this.emit("error",i),i}onSubmit(t,s){return this.loading=!1,this.submitting=!1,this.setPristine(!0),this.setValue(h.fastCloneDeep(t),{noValidate:!0,noCheck:!0}),this.setAlert("success",`<p>${this.t("complete")}</p>`),this.emit("submit",t),s&&this.emit("submitDone",t),t}onSubmissionError(t){return t&&("string"==typeof t&&(t={message:t}),"details"in t&&(t=t.details)),this.submitting=!1,this.setPristine(!1),this.emit("submitError",t),t&&t.silent?(this.emit("change",{isValid:!0}),!1):this.showErrors(t,!0)}onChange(s,e,i){s=s||{};let o=!1;e&&e.component&&(this.customErrors=this.customErrors.filter(t=>t.component&&t.component!==e.component.key)),super.onChange(s,!0);const n=t.clone(this.submission);s.changed=n.changed=e,i&&this.pristine&&(this.pristine=!1),n.isValid=this.checkData(n.data,s),this.loading=!1,this.submitted&&this.showErrors(),i&&this.options.saveDraft&&this.triggerSaveDraft(),s&&s.noEmit||(this.emit("change",n,s),o=!0),o&&!this.initialized&&(this.emit("initialized"),this.initialized=!0)}checkData(s,e={}){const i=super.checkData(s,e);return(t.isEmpty(e)||e.noValidate)&&this.submitted&&this.showErrors(),i}deleteSubmission(){return this.formio.deleteSubmission().then(()=>{this.emit("submissionDeleted",this.submission),this.resetValue()})}cancel(t){return!(!this.hook("beforeCancel",!0)||!t&&!confirm("Are you sure you want to cancel?"))&&(this.resetValue(),!0)}submitForm(e={}){return new n((i,n)=>{if(this.options.readOnly)return i({submission:this.submission,saved:!1});const r=h.fastCloneDeep(this.submission||{});r.metadata=r.metadata||{},t.defaults(r.metadata,{timezone:t.get(this,"_submission.metadata.timezone",h.currentTimezone()),offset:parseInt(t.get(this,"_submission.metadata.offset",s().utcOffset()),10),referrer:document.referrer,browserName:navigator.appName,userAgent:navigator.userAgent,pathName:window.location.pathname,onLine:navigator.onLine}),r.state=e.state||"submitted";const a="draft"===r.state;this.hook("beforeSubmit",{...r,component:e.component},s=>s?n(s):a||r.data?a||this.checkValidity(r.data,!0,r.data)?(this.everyComponent(s=>{const{persistent:e}=s.component;"client-only"===e&&t.unset(r.data,s.path)}),void this.hook("customValidation",{...r,component:e.component},t=>{if(t)return"string"==typeof t&&(t={message:t}),t=Array.isArray(t)?t:[t],this.customErrors=t,n();if(this.loading=!0,this._form&&this._form.action){const t=r.data._id&&this._form.action.includes(r.data._id)?"PUT":"POST";return o.makeStaticRequest(this._form.action,t,r,this.formio?this.formio.options:{}).then(t=>i({submission:t,saved:!0})).catch(n)}const s=this.formio;if(this.nosubmit||!s)return i({submission:r,saved:!1});s[s.actionUrl?"saveAction":"saveSubmission"](r).then(t=>i({submission:t,saved:!0})).catch(n)})):n():n("Invalid Submission"))})}executeSubmit(t){return this.submitted=!0,this.submitting=!0,this.submitForm(t).then(({submission:t,saved:s})=>this.onSubmit(t,s)).catch(t=>n.reject(this.onSubmissionError(t)))}submit(t,s){return t?this.executeSubmit(s):this.beforeSubmit(s).then(()=>this.executeSubmit(s))}submitUrl(t,s){if(!t)return console.warn("Missing URL argument");const e=this.submission||{},i=t,n={method:"POST",headers:{}};if(s&&s.length>0&&s.map(t=>{""!==t.header&&""!==t.value&&(n.headers[t.header]=this.interpolate(t.value,e))}),!i||!n)return this.emit("error","You should add a URL to this button."),this.setAlert("warning","You should add a URL to this button."),console.warn("You should add a URL to this button.");try{o.makeStaticRequest(i,n.method,e,{headers:n.headers}).then(()=>{this.emit("requestDone"),this.setAlert("success","<p> Success </p>")})}catch(t){this.showErrors(`${t.statusText} ${t.status}`),this.emit("error",`${t.statusText} ${t.status}`),console.error(`${t.statusText} ${t.status}`)}}triggerRecaptcha(){if(!this||!this.components)return;const t=this.components.find(t=>"recaptcha"===t.component.type&&"formLoad"===t.component.eventType);t&&t.verify(`${this.form.name?this.form.name:"form"}Load`)}set nosubmit(t){this._nosubmit=!!t,this.emit("nosubmit",this._nosubmit)}get nosubmit(){return this._nosubmit||!1}}return l.setBaseUrl=o.setBaseUrl,l.setApiUrl=o.setApiUrl,l.setAppUrl=o.setAppUrl,l});
//# sourceMappingURL=sourcemaps/Webform.js.map
