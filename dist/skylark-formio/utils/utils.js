/**
 * skylark-formio - A version of formio.js that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-formio/
 * @license MIT
 */
define(["skylark-lodash","../vendors/fetch-ponyfill/fetch","../vendors/json-logic-js/logic","../vendors/moment/timezone","../vendors/jstimezonedetect/jstz","./jsonlogic/operators","../vendors/getify/npo","../vendors/dompurify/purify","./formUtils","./Evaluator"],function(e,t,n,o,r,a,i,c,s,u){"use strict";const l=u.interpolate,{fetch:f}=t({Promise:i});function p(t,o,r,a){let i=null;const c=o.component?o.component:{key:"unknown"};!o.form&&o.instance&&(o.form=e.get(o.instance,"root._form",{}));const s=c.key;if("string"==typeof t){r&&(t+=`;return ${r}`),a&&(t=t.replace(/({{\s+(.*)\s+}})/,(t,n,r)=>0===r.indexOf("data.")?e.get(o.data,r.replace("data.","")):0===r.indexOf("row.")?e.get(o.row,r.replace("row.","")):e.get(o.data,r)));try{t=u.evaluator(t,o),o=e.values(o)}catch(e){console.warn(`An error occured within the custom function for ${s}`,e),i=null,t=!1}}if("function"==typeof t)try{i=u.evaluate(t,o)}catch(e){i=null,console.warn(`An error occured within custom function for ${s}`,e)}else if("object"==typeof t)try{i=n.apply(t,o)}catch(e){i=null,console.warn(`An error occured within custom function for ${s}`,e)}else t&&console.warn(`Unknown function type for ${s}`);return i}function d(e,t){let n=e.getPropertyValue(t);return n=n?n.replace(/[^0-9.]/g,""):"0",parseFloat(n)}function m(t,n,o,r){let a=null;o&&(a=s.getValue({data:o},n.when)),r&&e.isNil(a)&&(a=s.getValue({data:r},n.when)),e.isNil(a)&&(a="");const i=String(n.eq),c=String(n.show);return e.isObject(a)&&e.has(a,n.eq)?String(a[n.eq])===c:Array.isArray(a)&&a.map(String).includes(i)?"true"===c:String(a)===i==("true"===c)}function g(e,t,n,o,r,a,i,c){"string"==typeof t&&(t=`var ${a} = true; ${t}; return ${a};`);const s=c&&c.evaluate?c.evaluate(t):p(t,{row:n,data:o,form:r});return null===s?i:s}function h(t,o,r,a,i,c){try{return n.apply(o,{data:a,row:r,form:i,_:e})}catch(e){return console.warn(`An error occurred in jsonLogic advanced condition for ${t.key}`,e),c}}function y(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function C(){return o.currentTimezone?o.currentTimezone:(o.currentTimezone=r.determine().name(),o.currentTimezone)}function z(e,t){if("UTC"===t)return{date:new Date(e.getTime()+6e4*e.getTimezoneOffset()),abbr:"UTC"};const n=o(e).tz(t);return{date:new Date(e.getTime()+6e4*(n.utcOffset()+e.getTimezoneOffset())),abbr:n.format("z")}}function w(e){return e!==C()&&"UTC"!==e}function x(t){return t&&!w(t)?new i(e.noop):o.zonesPromise?o.zonesPromise:o.zonesPromise=f("https://cdn.form.io/moment-timezone/data/packed/latest.json").then(e=>e.json().then(e=>{if(o.tz.load(e),o.zonesLoaded=!0,document&&document.createEvent&&document.body&&document.body.dispatchEvent){var t=document.createEvent("Event");t.initEvent("zonesLoaded",!0,!0),document.body.dispatchEvent(t)}}))}function A(e){return e.replace(/y/g,"Y").replace(/d/g,"D").replace(/E/g,"d").replace(/a/g,"A").replace(/U/g,"X")}function T(e){return e.match(/(\d+)$/)?e.replace(/(\d+)$/,function(e){return Number(e)+1}):`${e}1`}function S(e){return"function"==typeof e?e():e}a.lodashOperators.forEach(t=>n.add_operation(`_${t}`,e[t])),n.add_operation("getDate",e=>o(e).toISOString()),n.add_operation("relativeMinDate",e=>o().subtract(e,"days").toISOString()),n.add_operation("relativeMaxDate",e=>o().add(e,"days").toISOString());const v=e.flow([e.partialRight(e.map,S),e.partialRight(e.find,t=>!e.isUndefined(t))]);return{jsonLogic:n,moment:o,evaluate:p,getRandomComponentId:function(){return`e${Math.random().toString(36).substring(7)}`},getPropertyValue:d,getElementRect:function(e){const t=window.getComputedStyle(e,null);return{x:d(t,"left"),y:d(t,"top"),width:d(t,"width"),height:d(t,"height")}},boolValue:function(t){return e.isBoolean(t)?t:e.isString(t)?"true"===t.toLowerCase():!!t},isMongoId:function(e){return e.toString().match(/^[0-9a-fA-F]{24}$/)},checkCalculated:function(t,n,o){t.calculateValue&&e.set(o,t.key,p(t.calculateValue,{value:void 0,data:n?n.data:o,row:o,util:this,component:t},"value"))},checkSimpleConditional:m,checkCustomConditional:g,checkJsonConditional:h,checkCondition:function(e,t,n,o,r){return e.customConditional?g(0,e.customConditional,t,n,o,"show",!0,r):e.conditional&&e.conditional.when?m(0,e.conditional,t,n):!e.conditional||!e.conditional.json||h(e,e.conditional.json,t,n,o,!0)},checkTrigger:function(e,t,n,o,r,a){if(!t[t.type])return!1;switch(t.type){case"simple":return m(0,t.simple,n,o);case"javascript":return g(0,t.javascript,n,o,r,"result",!1,a);case"json":return h(e,t.json,n,o,r,!1)}return!1},setActionProperty:function(t,n,o,r,a,i){const c=n.property.value;switch(n.property.type){case"boolean":{const o=e.get(t,c,!1).toString(),r=n.state.toString();o!==r&&e.set(t,c,"true"===r);break}case"string":{const s={data:a,row:r,component:t,result:o},l=n.property.component?n[n.property.component]:n.text,f=e.get(t,c,""),p=i&&i.interpolate?i.interpolate(l,s):u.interpolate(l,s);p!==f&&e.set(t,c,p);break}}return t},uniqueName:function(t,n,o){(n=n||"{{fileName}}-{{guid}}").includes("{{guid}}")||(n=`${n}-{{guid}}`);const r=t.split(".");let a=r.slice(0,r.length-1).join(".");const i=r.length>1?`.${e.last(r)}`:"";return a=a.substr(0,100),o=Object.assign(o||{},{fileName:a,guid:y()}),`${u.interpolate(n,o)}${i}`.replace(/[^0-9a-zA-Z.\-_ ]/g,"-")},guid:y,getDateSetting:function(t){if(e.isNil(t)||e.isNaN(t)||""===t)return null;if(t instanceof Date)return t;if("function"==typeof t.toDate)return t.isValid()?t.toDate():null;let n="string"!=typeof t||-1===t.indexOf("moment(")?o(t):null;if(n&&n.isValid())return n.toDate();n=null;try{const e=u.evaluator(`return ${t};`,"moment")(o);"string"==typeof e?n=o(e):"function"==typeof e.toDate?n=o(e.toDate().toUTCString()):e instanceof Date&&(n=o(e))}catch(e){return null}return n&&n.isValid()?n.toDate():null},isValidDate:function(t){return e.isDate(t)&&!e.isNaN(t.getDate())},currentTimezone:C,offsetDate:z,zonesLoaded:function(){return o.zonesLoaded},shouldLoadZones:w,loadZones:x,momentDate:function(e,t,n){const r=o(e);return"UTC"===n&&(n="Etc/UTC"),(n!==C()||t&&t.match(/\s(z$|z\s)/))&&o.zonesLoaded?r.tz(n):r},formatDate:function(e,t,n){const r=o(e);if(n===C())return t.match(/\s(z$|z\s)/)?(x(),o.zonesLoaded?r.tz(n).format(A(t)):r.format(A(t.replace(/\s(z$|z\s)/,"")))):r.format(A(t));if("UTC"===n){const e=z(r.toDate(),"UTC");return`${o(e.date).format(A(t))} UTC`}return x(),o.zonesLoaded?r.tz(n).format(`${A(t)} z`):r.format(A(t))},formatOffset:function(e,t,n,r){if(r===C())return e(t,n);if("UTC"===r)return`${e(z(t,"UTC").date,n)} UTC`;if(x(),o.zonesLoaded){const o=z(t,r);return`${e(o.date,n)} ${o.abbr}`}return e(t,n)},getLocaleDateFormatInfo:function(e){const t={},n=new Date(2017,11,21).toLocaleDateString(e);return t.dayFirst=n.slice(0,2)===21..toString(),t},convertFormatToFlatpickr:function(e){return e.replace(/Z/g,"").replace(/y/g,"Y").replace("YYYY","Y").replace("YY","y").replace("MMMM","F").replace(/M/g,"n").replace("nnn","M").replace("nn","m").replace(/d/g,"j").replace(/jj/g,"d").replace("EEEE","l").replace("EEE","D").replace("HH","H").replace("hh","G").replace("mm","i").replace("ss","S").replace(/a/g,"K")},convertFormatToMoment:A,convertFormatToMask:function(e){return e.replace(/M{4}/g,"MM").replace(/M{3}/g,"***").replace(/e/g,"Q").replace(/[ydhmsHMG]/g,"9").replace(/a/g,"AA")},getInputMask:function(e){if(e instanceof Array)return e;const t=[];t.numeric=!0;for(let n=0;n<e.length;n++)switch(e[n]){case"9":t.push(/\d/);break;case"A":t.numeric=!1,t.push(/[a-zA-Z]/);break;case"a":t.numeric=!1,t.push(/[a-z]/);break;case"*":t.numeric=!1,t.push(/[a-zA-Z0-9]/);break;default:t.numeric=!1,t.push(e[n])}return t},matchInputMask:function(t,n){if(!n)return!0;if(t.length>n.length)return!1;for(let o=0;o<n.length;o++){const r=t[o],a=n[o];if(!(e.isRegExp(a)&&a.test(r)||a===r))return!1}return!0},getNumberSeparators:function(e="en"){const t=12345.6789.toLocaleString(e).match(/..(.)...(.)../);return t?{delimiter:t.length>1?t[1]:",",decimalSeparator:t.length>2?t[2]:"."}:{delimiter:",",decimalSeparator:"."}},getNumberDecimalLimit:function(t,n){if(e.has(t,"decimalLimit"))return e.get(t,"decimalLimit");let o=n||20;const r=e.get(t,"validate.step","any");if("any"!==r){const e=r.toString().split(".");e.length>1&&(o=e[1].length)}return o},getCurrencyAffixes:function({currency:e="USD",decimalLimit:t,decimalSeparator:n,lang:o}){let r="(.*)?100";t&&(r+=`${"."===n?"\\.":n}0{${t}}`),r+="(.*)?";const a=100..toLocaleString(o,{style:"currency",currency:e,useGrouping:!0,maximumFractionDigits:t,minimumFractionDigits:t}).replace(".",n).match(new RegExp(r));return{prefix:a[1]||"",suffix:a[2]||""}},fieldData:function(e,t){if(!e)return"";if(!t||!t.key)return e;if(t.key.includes(".")){let n=e;const o=t.key.split(".");let r="";for(let e=0;e<o.length;e++){if(r=o[e],n.hasOwnProperty("_id")&&(n=n.data),!n.hasOwnProperty(r))return;r===o[o.length-1]&&t.multiple&&!Array.isArray(n[r])&&(n[r]=[n[r]]),n=n[r]}return n}return t.multiple&&!Array.isArray(e[t.key])&&(e[t.key]=[e[t.key]]),e[t.key]},delay:function(e,t=0,...n){const o=setTimeout(e,t,...n);function r(){clearTimeout(o)}function a(){return r(),e(...n)}return a.timer=o,a.cancel=r,a},iterateKey:T,uniqueKey:function(e,t){let n=t;for(;e.hasOwnProperty(n);)n=T(n);return n},bootstrapVersion:function(e){return e.bootstrap?e.bootstrap:"function"==typeof $&&"function"==typeof $().collapse?parseInt($.fn.collapse.Constructor.VERSION.split(".")[0],10):0},unfold:S,firstNonNil:v,withSwitch:function(e,t){let n=e,o=t;return[function(){return n},function(){const e=n;n=o,o=e}]},observeOverload:function(e,t={}){const{limit:n=50,delay:o=500}=t;let r=0,a=0;const i=()=>r=0;return()=>{if(0!==a&&(clearTimeout(a),a=0),a=setTimeout(i,o),(r+=1)>=n)return clearTimeout(a),i(),e()}},getContextComponents:function(e){const t=[];return e.utils.eachComponent(e.instance.options.editForm.components,(n,o)=>{n.key!==e.data.key&&t.push({label:`${n.label||n.key} (${o})`,value:n.key})}),t},sanitize:function(e,t){const n={ADD_ATTR:["ref","target"],USE_PROFILES:{html:!0}};return t.sanitizeConfig&&Array.isArray(t.sanitizeConfig.addAttr)&&t.sanitizeConfig.addAttr.length>0&&t.sanitizeConfig.addAttr.forEach(e=>{n.ADD_ATTR.push(e)}),t.sanitizeConfig&&Array.isArray(t.sanitizeConfig.addTags)&&t.sanitizeConfig.addTags.length>0&&(n.ADD_TAGS=t.sanitizeConfig.addTags),t.sanitizeConfig&&Array.isArray(t.sanitizeConfig.allowedTags)&&t.sanitizeConfig.allowedTags.length>0&&(n.ALLOWED_TAGS=t.sanitizeConfig.allowedTags),t.sanitizeConfig&&Array.isArray(t.sanitizeConfig.allowedAttrs)&&t.sanitizeConfig.allowedAttrs.length>0&&(n.ALLOWED_ATTR=t.sanitizeConfig.allowedAttrs),t.sanitizeConfig&&t.sanitizeConfig.allowedUriRegex&&(n.ALLOWED_URI_REGEXP=t.sanitizeConfig.allowedUriRegex),c.sanitize(e,n)},fastCloneDeep:function(e){return e?JSON.parse(JSON.stringify(e)):e},Evaluator:u,interpolate:l,isInputComponent:function(e){if(!1===e.input||!0===e.input)return e.input;switch(e.type){case"htmlelement":case"content":case"columns":case"fieldset":case"panel":case"table":case"tabs":case"well":case"button":return!1;default:return!0}},isLayoutComponent:s.isLayoutComponent,eachComponent:s.eachComponent,matchComponent:s.matchComponent,getComponent:s.getComponent,searchComponents:s.searchComponents,findComponents:s.findComponents,findComponent:s.findComponent,removeComponent:s.removeComponent,generateFormChange:s.generateFormChange,applyFormChanges:s.applyFormChanges,flattenComponents:s.flattenComponents,hasCondition:s.hasCondition,parseFloatExt:s.parseFloatExt,formatAsCurrency:s.formatAsCurrency,escapeRegExCharacters:s.escapeRegExCharacters,getValue:s.getValue,getStrings:s.getStrings}});
//# sourceMappingURL=../sourcemaps/utils/utils.js.map
