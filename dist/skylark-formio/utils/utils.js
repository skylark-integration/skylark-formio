/**
 * skylark-formio - A version of formio.js that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-formio/
 * @license MIT
 */
define(["skylark-lodash","../vendors/fetch-ponyfill/fetch","../vendors/json-logic-js/logic","../vendors/moment/timezone","../vendors/jstimezonedetect/jstz","./jsonlogic/operators","../vendors/getify/npo","../vendors/dompurify/purify","./formUtils","./Evaluator"],function(e,t,n,r,o,a,i,c,s,u){"use strict";const l=u.interpolate,{fetch:f}=t({Promise:i});function d(t,r,o,a){let i=null;const c=r.component?r.component:{key:"unknown"};!r.form&&r.instance&&(r.form=e.get(r.instance,"root._form",{}));const s=c.key;if("string"==typeof t){o&&(t+=`;return ${o}`),a&&(t=t.replace(/({{\s+(.*)\s+}})/,(t,n,o)=>0===o.indexOf("data.")?e.get(r.data,o.replace("data.","")):0===o.indexOf("row.")?e.get(r.row,o.replace("row.","")):e.get(r.data,o)));try{t=u.evaluator(t,r),r=e.values(r)}catch(e){console.warn(`An error occured within the custom function for ${s}`,e),i=null,t=!1}}if("function"==typeof t)try{i=u.evaluate(t,r)}catch(e){i=null,console.warn(`An error occured within custom function for ${s}`,e)}else if("object"==typeof t)try{i=n.apply(t,r)}catch(e){i=null,console.warn(`An error occured within custom function for ${s}`,e)}else t&&console.warn(`Unknown function type for ${s}`);return i}function p(e,t){let n=e.getPropertyValue(t);return n=n?n.replace(/[^0-9.]/g,""):"0",parseFloat(n)}function g(t,n,r,o){let a=null;r&&(a=s.getValue({data:r},n.when)),o&&e.isNil(a)&&(a=s.getValue({data:o},n.when)),e.isNil(a)&&(a="");const i=String(n.eq),c=String(n.show);return e.isObject(a)&&e.has(a,n.eq)?String(a[n.eq])===c:Array.isArray(a)&&a.map(String).includes(i)?"true"===c:String(a)===i==("true"===c)}function m(e,t,n,r,o,a,i,c){"string"==typeof t&&(t=`var ${a} = true; ${t}; return ${a};`);const s=c&&c.evaluate?c.evaluate(t):d(t,{row:n,data:r,form:o});return null===s?i:s}function y(t,r,o,a,i,c){try{return n.apply(r,{data:a,row:o,form:i,_:e})}catch(e){return console.warn(`An error occurred in jsonLogic advanced condition for ${t.key}`,e),c}}function h(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function z(){return r.currentTimezone?r.currentTimezone:(r.currentTimezone=o.determine().name(),r.currentTimezone)}function w(e,t){if("UTC"===t)return{date:new Date(e.getTime()+6e4*e.getTimezoneOffset()),abbr:"UTC"};const n=r(e).tz(t);return{date:new Date(e.getTime()+6e4*(n.utcOffset()+e.getTimezoneOffset())),abbr:n.format("z")}}function C(e){return e!==z()&&"UTC"!==e}function x(t){return t&&!C(t)?new i(e.noop):r.zonesPromise?r.zonesPromise:r.zonesPromise=f("https://cdn.form.io/moment-timezone/data/packed/latest.json").then(e=>e.json().then(e=>{if(r.tz.load(e),r.zonesLoaded=!0,document&&document.createEvent&&document.body&&document.body.dispatchEvent){var t=document.createEvent("Event");t.initEvent("zonesLoaded",!0,!0),document.body.dispatchEvent(t)}}))}function A(e){return e.replace(/y/g,"Y").replace(/d/g,"D").replace(/E/g,"d").replace(/a/g,"A").replace(/U/g,"X")}function T(e){return e.match(/(\d+)$/)?e.replace(/(\d+)$/,function(e){return Number(e)+1}):`${e}1`}function D(e){return"function"==typeof e?e():e}a.lodashOperators.forEach(t=>n.add_operation(`_${t}`,e[t])),n.add_operation("getDate",e=>r(e).toISOString()),n.add_operation("relativeMinDate",e=>r().subtract(e,"days").toISOString()),n.add_operation("relativeMaxDate",e=>r().add(e,"days").toISOString());const S=e.flow([e.partialRight(e.map,D),e.partialRight(e.find,t=>!e.isUndefined(t))]);return{jsonLogic:n,moment:r,evaluate:d,getRandomComponentId:function(){return`e${Math.random().toString(36).substring(7)}`},getPropertyValue:p,getElementRect:function(e){const t=window.getComputedStyle(e,null);return{x:p(t,"left"),y:p(t,"top"),width:p(t,"width"),height:p(t,"height")}},boolValue:function(t){return e.isBoolean(t)?t:e.isString(t)?"true"===t.toLowerCase():!!t},isMongoId:function(e){return e.toString().match(/^[0-9a-fA-F]{24}$/)},checkCalculated:function(t,n,r){t.calculateValue&&e.set(r,t.key,d(t.calculateValue,{value:void 0,data:n?n.data:r,row:r,util:this,component:t},"value"))},checkSimpleConditional:g,checkCustomConditional:m,checkJsonConditional:y,checkCondition:function(e,t,n,r,o){return e.customConditional?m(0,e.customConditional,t,n,r,"show",!0,o):e.conditional&&e.conditional.when?g(0,e.conditional,t,n):!e.conditional||!e.conditional.json||y(e,e.conditional.json,t,n,r,!0)},checkTrigger:function(e,t,n,r,o,a){if(!t[t.type])return!1;switch(t.type){case"simple":return g(0,t.simple,n,r);case"javascript":return m(0,t.javascript,n,r,o,"result",!1,a);case"json":return y(e,t.json,n,r,o,!1)}return!1},setActionProperty:function(t,n,r,o,a,i){const c=n.property.value;switch(n.property.type){case"boolean":{const r=e.get(t,c,!1).toString(),o=n.state.toString();r!==o&&e.set(t,c,"true"===o);break}case"string":{const s={data:a,row:o,component:t,result:r},l=n.property.component?n[n.property.component]:n.text,f=e.get(t,c,""),d=i&&i.interpolate?i.interpolate(l,s):u.interpolate(l,s);d!==f&&e.set(t,c,d);break}}return t},uniqueName:function(t,n,r){(n=n||"{{fileName}}-{{guid}}").includes("{{guid}}")||(n=`${n}-{{guid}}`);const o=t.split(".");let a=o.slice(0,o.length-1).join(".");const i=o.length>1?`.${e.last(o)}`:"";return a=a.substr(0,100),r=Object.assign(r||{},{fileName:a,guid:h()}),`${u.interpolate(n,r)}${i}`.replace(/[^0-9a-zA-Z.\-_ ]/g,"-")},guid:h,getDateSetting:function(t){if(e.isNil(t)||e.isNaN(t)||""===t)return null;if(t instanceof Date)return t;if("function"==typeof t.toDate)return t.isValid()?t.toDate():null;let n="string"!=typeof t||-1===t.indexOf("moment(")?r(t):null;if(n&&n.isValid())return n.toDate();n=null;try{const e=u.evaluator(`return ${t};`,"moment")(r);"string"==typeof e?n=r(e):"function"==typeof e.toDate?n=r(e.toDate().toUTCString()):e instanceof Date&&(n=r(e))}catch(e){return null}return n&&n.isValid()?n.toDate():null},isValidDate:function(t){return e.isDate(t)&&!e.isNaN(t.getDate())},currentTimezone:z,offsetDate:w,zonesLoaded:function(){return r.zonesLoaded},shouldLoadZones:C,loadZones:x,momentDate:function(e,t,n){const o=r(e);return"UTC"===n&&(n="Etc/UTC"),(n!==z()||t&&t.match(/\s(z$|z\s)/))&&r.zonesLoaded?o.tz(n):o},formatDate:function(e,t,n){const o=r(e);if(n===z())return t.match(/\s(z$|z\s)/)?(x(),r.zonesLoaded?o.tz(n).format(A(t)):o.format(A(t.replace(/\s(z$|z\s)/,"")))):o.format(A(t));if("UTC"===n){const e=w(o.toDate(),"UTC");return`${r(e.date).format(A(t))} UTC`}return x(),r.zonesLoaded?o.tz(n).format(`${A(t)} z`):o.format(A(t))},formatOffset:function(e,t,n,o){if(o===z())return e(t,n);if("UTC"===o)return`${e(w(t,"UTC").date,n)} UTC`;if(x(),r.zonesLoaded){const r=w(t,o);return`${e(r.date,n)} ${r.abbr}`}return e(t,n)},getLocaleDateFormatInfo:function(e){const t={},n=new Date(2017,11,21).toLocaleDateString(e);return t.dayFirst=n.slice(0,2)===21..toString(),t},convertFormatToFlatpickr:function(e){return e.replace(/Z/g,"").replace(/y/g,"Y").replace("YYYY","Y").replace("YY","y").replace("MMMM","F").replace(/M/g,"n").replace("nnn","M").replace("nn","m").replace(/d/g,"j").replace(/jj/g,"d").replace("EEEE","l").replace("EEE","D").replace("HH","H").replace("hh","G").replace("mm","i").replace("ss","S").replace(/a/g,"K")},convertFormatToMoment:A,convertFormatToMask:function(e){return e.replace(/M{4}/g,"MM").replace(/M{3}/g,"***").replace(/e/g,"Q").replace(/[ydhmsHMG]/g,"9").replace(/a/g,"AA")},getInputMask:function(e){if(e instanceof Array)return e;const t=[];t.numeric=!0;for(let n=0;n<e.length;n++)switch(e[n]){case"9":t.push(/\d/);break;case"A":t.numeric=!1,t.push(/[a-zA-Z]/);break;case"a":t.numeric=!1,t.push(/[a-z]/);break;case"*":t.numeric=!1,t.push(/[a-zA-Z0-9]/);break;default:t.numeric=!1,t.push(e[n])}return t},matchInputMask:function(t,n){if(!n)return!0;if(t.length>n.length)return!1;for(let r=0;r<n.length;r++){const o=t[r],a=n[r];if(!(e.isRegExp(a)&&a.test(o)||a===o))return!1}return!0},getNumberSeparators:function(e="en"){const t=12345.6789.toLocaleString(e).match(/..(.)...(.)../);return t?{delimiter:t.length>1?t[1]:",",decimalSeparator:t.length>2?t[2]:"."}:{delimiter:",",decimalSeparator:"."}},getNumberDecimalLimit:function(t,n){if(e.has(t,"decimalLimit"))return e.get(t,"decimalLimit");let r=n||20;const o=e.get(t,"validate.step","any");if("any"!==o){const e=o.toString().split(".");e.length>1&&(r=e[1].length)}return r},getCurrencyAffixes:function({currency:e="USD",decimalLimit:t,decimalSeparator:n,lang:r}){let o="(.*)?100";t&&(o+=`${"."===n?"\\.":n}0{${t}}`),o+="(.*)?";const a=100..toLocaleString(r,{style:"currency",currency:e,useGrouping:!0,maximumFractionDigits:t,minimumFractionDigits:t}).replace(".",n).match(new RegExp(o));return{prefix:a[1]||"",suffix:a[2]||""}},fieldData:function(e,t){if(!e)return"";if(!t||!t.key)return e;if(t.key.includes(".")){let n=e;const r=t.key.split(".");let o="";for(let e=0;e<r.length;e++){if(o=r[e],n.hasOwnProperty("_id")&&(n=n.data),!n.hasOwnProperty(o))return;o===r[r.length-1]&&t.multiple&&!Array.isArray(n[o])&&(n[o]=[n[o]]),n=n[o]}return n}return t.multiple&&!Array.isArray(e[t.key])&&(e[t.key]=[e[t.key]]),e[t.key]},delay:function(e,t=0,...n){const r=setTimeout(e,t,...n);function o(){clearTimeout(r)}function a(){return o(),e(...n)}return a.timer=r,a.cancel=o,a},iterateKey:T,uniqueKey:function(e,t){let n=t;for(;e.hasOwnProperty(n);)n=T(n);return n},bootstrapVersion:function(e){return e.bootstrap?e.bootstrap:"function"==typeof $&&"function"==typeof $().collapse?parseInt($.fn.collapse.Constructor.VERSION.split(".")[0],10):0},unfold:D,firstNonNil:S,withSwitch:function(e,t){let n=e,r=t;return[function(){return n},function(){const e=n;n=r,r=e}]},observeOverload:function(e,t={}){const{limit:n=50,delay:r=500}=t;let o=0,a=0;const i=()=>o=0;return()=>{if(0!==a&&(clearTimeout(a),a=0),a=setTimeout(i,r),(o+=1)>=n)return clearTimeout(a),i(),e()}},getContextComponents:function(e){const t=[];return e.utils.eachComponent(e.instance.options.editForm.components,(n,r)=>{n.key!==e.data.key&&t.push({label:`${n.label||n.key} (${r})`,value:n.key})}),t},sanitize:function(e,t){const n={ADD_ATTR:["ref","target"],USE_PROFILES:{html:!0}};return t.sanitizeConfig&&Array.isArray(t.sanitizeConfig.addAttr)&&t.sanitizeConfig.addAttr.length>0&&t.sanitizeConfig.addAttr.forEach(e=>{n.ADD_ATTR.push(e)}),t.sanitizeConfig&&Array.isArray(t.sanitizeConfig.addTags)&&t.sanitizeConfig.addTags.length>0&&(n.ADD_TAGS=t.sanitizeConfig.addTags),t.sanitizeConfig&&Array.isArray(t.sanitizeConfig.allowedTags)&&t.sanitizeConfig.allowedTags.length>0&&(n.ALLOWED_TAGS=t.sanitizeConfig.allowedTags),t.sanitizeConfig&&Array.isArray(t.sanitizeConfig.allowedAttrs)&&t.sanitizeConfig.allowedAttrs.length>0&&(n.ALLOWED_ATTR=t.sanitizeConfig.allowedAttrs),t.sanitizeConfig&&t.sanitizeConfig.allowedUriRegex&&(n.ALLOWED_URI_REGEXP=t.sanitizeConfig.allowedUriRegex),c.sanitize(e,n)},fastCloneDeep:function(e){return e?JSON.parse(JSON.stringify(e)):e},Evaluator:u,interpolate:l,isInputComponent:function(e){if(!1===e.input||!0===e.input)return e.input;switch(e.type){case"htmlelement":case"content":case"columns":case"fieldset":case"panel":case"table":case"tabs":case"well":case"button":return!1;default:return!0}}}});
//# sourceMappingURL=../sourcemaps/utils/utils.js.map
