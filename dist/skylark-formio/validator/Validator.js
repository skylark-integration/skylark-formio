/**
 * skylark-formio - A version of formio.js that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-formio/
 * @license MIT
 */
define(["skylark-lodash","../utils/utils","skylark-moment","../vendors/getify/npo","../vendors/fetch-ponyfill/fetch","../utils/calendarUtils","./Rules"],function(e,a,t,r,s,n,l){"use strict";const{fetch:i,Headers:o,Request:c}=s({Promise:r});class d{constructor(s={}){this.config=e.defaults(s,d.config),this.validators={required:{key:"validate.required",method:"validateRequired",message:e=>e.t(e.errorMessage("required"),{field:e.errorLabel,data:e.data}),check(e,t,r){if(!a.boolValue(t)||e.isValueHidden())return!0;const s=e.validators.some(e=>"calendar"===e);return!r&&s&&e.widget.enteredDate?!this.validators.calendar.check.call(this,e,t,r):!e.isEmpty(r)}},unique:{key:"validate.unique",message:e=>e.t(e.errorMessage("unique"),{field:e.errorLabel,data:e.data}),check(t,s,n){return!a.boolValue(s)||(!(n&&!e.isEmpty(n))||(!this.config.db||new r(r=>{const s=this.config.form,l=this.config.submission,i=`data.${t.path}`,o={form:s._id};e.isString(n)?o[i]={$regex:new RegExp(`^${a.escapeRegExCharacters(n)}$`),$options:"i"}:e.isPlainObject(n)&&n.address&&n.address.address_components&&n.address.place_id?o[`${i}.address.place_id`]={$regex:new RegExp(`^${a.escapeRegExCharacters(n.address.place_id)}$`),$options:"i"}:e.isArray(n)?o[i]={$all:n}:e.isObject(n)&&(o[i]={$eq:n}),o.deleted={$eq:null},this.config.db.findOne(o,(e,a)=>r(!e&&(!a||l._id&&a._id.toString()===l._id)))}).catch(()=>!1)))}},multiple:{key:"validate.multiple",message(e){const t=a.boolValue(e.component.multiple)||Array.isArray(e.emptyValue),r=e.component.validate.required,s=t?r?"array_nonempty":"array":"nonarray";return e.t(e.errorMessage(s),{field:e.errorLabel,data:e.data})},check(t,r,s){if(!t.validateMultiple())return!0;const n=a.boolValue(r),l=Array.isArray(t.emptyValue),i=Array.isArray(s),o=t.component.validate.required;return n?i?!o||!!s.length:!!e.isNil(s)&&!o:l||!i}},select:{key:"validate.select",message:e=>e.t(e.errorMessage("select"),{field:e.errorLabel,data:e.data}),check(t,r,s,n,l,d,u){if(!a.boolValue(r))return!0;if(!s||e.isEmpty(s))return!0;if(!u)return!0;const m=t.component,g={url:r,method:"GET",qs:{},json:!0,headers:{}};if(e.isBoolean(g.url)){if(g.url=!!g.url,!g.url||"url"!==m.dataSrc||!m.data.url||!m.searchField)return!0;g.url=m.data.url,g.qs[m.searchField]=s,m.filter&&(g.url+=(g.url.includes("?")?"&":"?")+m.filter),m.selectFields&&(g.qs.select=m.selectFields)}return!g.url||(g.url=a.interpolate(g.url,{data:t.data}),g.url+=(g.url.includes("?")?"&":"?")+e.chain(g.qs).map((e,a)=>`${encodeURIComponent(a)}=${encodeURIComponent(e)}`).join("&").value(),m.data&&m.data.headers&&e.each(m.data.headers,e=>{e.key&&(g.headers[e.key]=e.value)}),m.authenticate&&this.config.token&&(g.headers["x-jwt-token"]=this.config.token),i(new c(g.url,{headers:new o(g.headers)})).then(e=>!!e.ok&&e.json()).then(e=>e&&e.length).catch(()=>!1))}},min:{key:"validate.min",message:(e,a)=>e.t(e.errorMessage("min"),{field:e.errorLabel,min:parseFloat(a),data:e.data}),check(a,t,r){const s=parseFloat(t);return!(!Number.isNaN(s)&&e.isNumber(r))||parseFloat(r)>=s}},max:{key:"validate.max",message:(e,a)=>e.t(e.errorMessage("max"),{field:e.errorLabel,max:parseFloat(a),data:e.data}),check(a,t,r){const s=parseFloat(t);return!(!Number.isNaN(s)&&e.isNumber(r))||parseFloat(r)<=s}},minSelectedCount:{key:"validate.minSelectedCount",message:(e,a)=>e.component.minSelectedCountMessage?e.component.minSelectedCountMessage:e.t(e.errorMessage("minSelectedCount"),{minCount:parseFloat(a),data:e.data}),check(e,a,t){const r=parseFloat(a);return!r||Object.keys(t).reduce((e,a)=>(t[a]&&e++,e),0)>=r}},maxSelectedCount:{key:"validate.maxSelectedCount",message:(e,a)=>e.component.maxSelectedCountMessage?e.component.maxSelectedCountMessage:e.t(e.errorMessage("maxSelectedCount"),{minCount:parseFloat(a),data:e.data}),check(e,a,t){const r=parseFloat(a);return!r||Object.keys(t).reduce((e,a)=>(t[a]&&e++,e),0)<=r}},minLength:{key:"validate.minLength",message:(e,a)=>e.t(e.errorMessage("minLength"),{field:e.errorLabel,length:a,data:e.data}),check(e,a,t){const r=parseInt(a,10);return!(r&&"string"==typeof t&&!e.isEmpty(t))||t.length>=r}},maxLength:{key:"validate.maxLength",message:(e,a)=>e.t(e.errorMessage("maxLength"),{field:e.errorLabel,length:a,data:e.data}),check(e,a,t){const r=parseInt(a,10);return!r||"string"!=typeof t||t.length<=r}},maxWords:{key:"validate.maxWords",message:(e,a)=>e.t(e.errorMessage("maxWords"),{field:e.errorLabel,length:a,data:e.data}),check(e,a,t){const r=parseInt(a,10);return!r||"string"!=typeof t||t.trim().split(/\s+/).length<=r}},minWords:{key:"validate.minWords",message:(e,a)=>e.t(e.errorMessage("minWords"),{field:e.errorLabel,length:a,data:e.data}),check(e,a,t){const r=parseInt(a,10);return!r||"string"!=typeof t||t.trim().split(/\s+/).length>=r}},email:{message:e=>e.t(e.errorMessage("invalid_email"),{field:e.errorLabel,data:e.data}),check:(e,a,t)=>!t||/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(t)},url:{message:e=>e.t(e.errorMessage("invalid_url"),{field:e.errorLabel,data:e.data}),check:(e,a,t)=>!t||/[-a-zA-Z0-9@:%._+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_+.~#?&//=]*)/.test(t)},date:{message:e=>e.t(e.errorMessage("invalid_date"),{field:e.errorLabel,data:e.data}),check:(e,a,t)=>"Invalid date"!==t},day:{message:e=>e.t(e.errorMessage("invalid_day"),{field:e.errorLabel,data:e.data}),check(e,a,t){if(!t)return!0;const[r,s,n]=e.dayFirst?[0,1,2]:[1,0,2],l=t.split("/").map(e=>parseInt(e,10)),i=l[r],o=l[s],c=l[n],d=function(e,a){switch(e){case 1:case 3:case 5:case 7:case 8:case 10:case 12:return 31;case 4:case 6:case 9:case 11:return 30;case 2:return function(e){return!(e%400&&(!(e%100)||e%4))}(a)?29:28;default:return 31}}(o,c);return!(i<0||i>d)&&(!(o<0||o>12)&&!(c<0||c>9999))}},pattern:{key:"validate.pattern",message:(a,t)=>a.t(e.get(a,"component.validate.patternMessage",a.errorMessage("pattern"),{field:a.errorLabel,pattern:t,data:a.data})),check:(e,a,t)=>!a||new RegExp(`^${a}$`).test(t)},json:{key:"validate.json",check(e,a,t,r,s,n){if(!a)return!0;const l=e.evaluate(a,{data:r,row:n,rowIndex:s,input:t});return null===l||l}},mask:{key:"inputMask",message:e=>e.t(e.errorMessage("mask"),{field:e.errorLabel,data:e.data}),check(e,t,r){let s;if(e.isMultipleMasksField){const a=r?r.maskName:void 0,t=e.getMaskByName(a);t&&(s=t),r=r?r.value:r}else s=t;return s=s?a.getInputMask(s):null,!r||!s||a.matchInputMask(r,s)}},custom:{key:"validate.custom",message:e=>e.t(e.errorMessage("custom"),{field:e.errorLabel,data:e.data}),check(e,a,t,r,s,n){if(!a)return!0;const l=e.evaluate(a,{valid:!0,data:r,rowIndex:s,row:n,input:t},"valid",!0);return null===l||l}},maxDate:{key:"maxDate",message(e,r){const s=a.getDateSetting(r);return e.t(e.errorMessage("maxDate"),{field:e.errorLabel,maxDate:t(s).format(e.format)})},check(r,s,n){if(r.isPartialDay&&r.isPartialDay(n))return!0;const l=t(n),i=a.getDateSetting(s);return!!e.isNull(i)||(i.setHours(0,0,0,0),l.isBefore(i)||l.isSame(i))}},minDate:{key:"minDate",message(e,r){const s=a.getDateSetting(r);return e.t(e.errorMessage("minDate"),{field:e.errorLabel,minDate:t(s).format(e.format)})},check(r,s,n){if(r.isPartialDay&&r.isPartialDay(n))return!0;const l=t(n),i=a.getDateSetting(s);return!!e.isNull(i)||(i.setHours(0,0,0,0),l.isAfter(i)||l.isSame(i))}},minYear:{key:"minYear",message:(e,a)=>e.t(e.errorMessage("minYear"),{field:e.errorLabel,minYear:a}),check(e,a,t){const r=a;let s=/\d{4}$/.exec(t);return s=s?s[0]:null,!+r||!+s||+s>=+r}},maxYear:{key:"maxYear",message:(e,a)=>e.t(e.errorMessage("maxYear"),{field:e.errorLabel,maxYear:a}),check(e,a,t){const r=a;let s=/\d{4}$/.exec(t);return s=s?s[0]:null,!+r||!+s||+s<=+r}},calendar:{key:"validate.calendar",messageText:"",message(e){return e.t(e.errorMessage(this.validators.calendar.messageText),{field:e.errorLabel,maxDate:t(e.dataValue).format(e.format)})},check(e,r,s,l,i){this.validators.calendar.messageText="";const o=e.getWidget(i);if(!o)return!0;const{settings:c,enteredDate:d}=o,{minDate:u,maxDate:m,format:g}=c,h=[a.convertFormatToMoment(g)];if(h[0].match(/M{3,}/g)&&h.push(h[0].replace(/M{3,}/g,"MM")),!s&&d){const{message:e,result:a}=n.checkInvalidDate(d,h,u,m);if(!a)return this.validators.calendar.messageText=e,a}return s&&d?t(s).format()!==t(d,h,!0).format()&&d.match(/_/gi)?(this.validators.calendar.messageText=n.CALENDAR_ERROR_MESSAGES.INCOMPLETE,!1):(o.enteredDate="",!0):void 0}}}}checkValidator(e,a,t,s,n,l,i,o){let c=null;c=a.method&&"function"==typeof e[a.method]?e[a.method](t,s,n,l,i,o):a.check.call(this,e,t,s,n,l,i,o);const d=r=>"string"==typeof r?r:!r&&a.message?a.message.call(this,e,t,l,i):"";return o?r.resolve(c).then(d):d(c)}validate(a,t,s,n,l,i,o){if(!a.conditionallyVisible())return!1;const c=this.validators[t],d=e.get(a.component,c.key,null),u=this.checkValidator(a,c,d,s,n,l,i,o),m=r=>!!r&&{message:e.get(r,"message",r),level:"warning"===e.get(r,"level")?"warning":"error",path:(a.path||"").replace(/[[\]]/g,".").replace(/\.\./g,".").split(".").map(a=>e.defaultTo(e.toNumber(a),a)),context:{validator:t,setting:d,key:a.key,label:a.label,value:s}};return o?r.resolve(u).then(m):m(u)}checkComponent(a,t,s,n=!1,l=!1){if("undefined"!=typeof process&&"node"===e.get(process,"release.name")&&!e.defaultTo(a.component.persistent,!0)||!1===a.component.validate)return l?r.resolve([]):[];t=t||a.rootValue,s=s||a.data;const i=a.component.multiple&&Array.isArray(a.validationValue)?a.validationValue:[a.validationValue],o=e.get(a,"component.validations");if(o&&Array.isArray(o)){const e=this.checkValidations(a,o,t,s,i,l),c=e=>n?e:e.filter(e=>"error"===e.level);return l?r.all(e).then(c):c(e)}const c=e.get(a,"component.validate.custom"),d=e.get(a,"component.validate.customMessage"),u=e(a.validators).chain().map(r=>this.validators.hasOwnProperty(r)?"required"!==r||i.length?e.map(i,(e,n)=>this.validate(a,r,e,t,n,s,l)):[this.validate(a,r,null,t,0,s,l)]:{message:`Validator for "${r}" is not defined`,level:"warning",context:{validator:r,key:a.key,label:a.label}}).flatten().value();a.component.validate=a.component.validate||{},a.component.validate.unique=a.component.unique,u.push(this.validate(a,"unique",a.validationValue,t,0,t,l)),a.component.validate.multiple=a.component.multiple,u.push(this.validate(a,"multiple",a.validationValue,t,0,t,l));const m=r=>(r=e(r).chain().flatten().compact().value(),(d||c)&&e.each(r,e=>{e.message=a.t(d||e.message,{field:a.errorLabel,data:t,row:s,error:e})}),n?r:e.reject(r,e=>"warning"===e.level));return l?r.all(u).then(m):m(u)}checkValidations(e,a,t,r,s,n){const l=a.map(a=>this.checkRule(e,a,t,r,s,n)).reduce((e,a)=>a?[...e,...a]:e,[]).filter(e=>e).reduce((e,a)=>(e[a.context.validator]=a,e),{});return Object.values(l)}checkRule(e,a,t,r,s,n){const i=l.getRule(a.rule),o=[];if(i){const l=new i(e,a.settings,this.config);s.map((s,i)=>{const c=l.check(s,t,r,n);!0!==c&&o.push({level:a.level||"error",message:e.t(a.message||l.defaultMessage,{settings:a.settings,field:e.errorLabel,data:t,row:r,error:c}),context:{key:e.key,index:i,label:e.label,validator:a.rule}})})}return 0!==o.length&&o}get check(){return this.checkComponent}get(){e.get.call(this,arguments)}each(){e.each.call(this,arguments)}has(){e.has.call(this,arguments)}}return d.config={db:null,token:null,form:null,submission:null},{instance:new d,ValidationChecker:d}});
//# sourceMappingURL=../sourcemaps/validator/Validator.js.map
