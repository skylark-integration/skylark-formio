/**
 * skylark-formio - A version of formio.js that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-formio/
 * @license MIT
 */
define(["skylark-lodash","./vendors/getify/npo","./vendors/fetch-ponyfill/fetch","./Formio","./WebformBuilder","./utils/utils","./utils/builder","./PDF"],function(e,t,r,s,i,o,n,a){"use strict";const{fetch:h,Headers:d}=r({Promise:t});return class extends i{constructor(){let e,t;arguments[0]instanceof HTMLElement||arguments[1]?(e=arguments[0],t=arguments[1]):t=arguments[0],t.skipInit=!0,e?super(e,t):super(t),this.dragDropEnabled=!1}get defaultGroups(){return{pdf:{title:"PDF Fields",weight:0,default:!0,components:{textfield:!0,number:!0,password:!0,email:!0,phoneNumber:!0,currency:!0,checkbox:!0,signature:!0,select:!0,textarea:!0,datetime:!0,file:!0}},basic:!1,advanced:!1,layout:!1,data:!1,premium:!1,resource:!1}}get hasPDF(){return e.has(this.webform.form,"settings.pdf")}get projectUrl(){return this.options.projectUrl||s.getProjectUrl()}init(){this.options.attachMode="builder",this.webform=this.webform||this.createForm(this.options),this.webform.init()}render(){return this.renderTemplate("pdfBuilder",{sidebar:this.renderTemplate("builderSidebar",{scrollEnabled:this.sideBarScroll,groupOrder:this.groupOrder,groupId:`builder-sidebar-${this.id}`,groups:this.groupOrder.map(e=>this.renderTemplate("builderSidebarGroup",{group:this.groups[e],groupKey:e,groupId:`builder-sidebar-${this.id}`,subgroups:this.groups[e].subgroups.map(t=>this.renderTemplate("builderSidebarGroup",{group:t,groupKey:t.key,groupId:`builder-sidebar-${e}`,subgroups:[]}))}))}),form:this.hasPDF?this.webform.render():this.renderTemplate("pdfBuilderUpload",{})})}attach(e){if(!this.hasPDF){if(this.loadRefs(e,{fileDrop:"single",fileBrowse:"single",hiddenFileInputElement:"single",uploadError:"single"}),this.addEventListener(this.refs["pdf-upload-button"],"click",e=>{e.preventDefault()}),this.projectUrl?this.setUploadError():this.setUploadError('Form options.projectUrl not set. Please set the "projectUrl" property of the options for this form or use Formio.setProjectUrl(). This setting is necessary to upload a pdf background.'),this.refs.fileDrop){const e=this;this.addEventListener(this.refs.fileDrop,"dragover",function(e){this.className="fileSelector fileDragOver",e.preventDefault()}),this.addEventListener(this.refs.fileDrop,"dragleave",function(e){this.className="fileSelector",e.preventDefault()}),this.addEventListener(this.refs.fileDrop,"drop",function(t){return this.className="fileSelector",t.preventDefault(),e.upload(t.dataTransfer.files[0]),!1})}return this.refs.fileBrowse&&this.refs.hiddenFileInputElement&&(this.addEventListener(this.refs.fileBrowse,"click",e=>{e.preventDefault(),"function"==typeof this.refs.hiddenFileInputElement.trigger?this.refs.hiddenFileInputElement.trigger("click"):this.refs.hiddenFileInputElement.click()}),this.addEventListener(this.refs.hiddenFileInputElement,"change",()=>{this.upload(this.refs.hiddenFileInputElement.files[0]),this.refs.hiddenFileInputElement.value=""})),t.resolve()}return super.attach(e).then(()=>(this.loadRefs(this.element,{iframeDropzone:"single","sidebar-container":"multiple"}),this.afterAttach(),this.element))}afterAttach(){this.initIframeEvents(),this.updateDropzoneDimensions(),this.initDropzoneEvents(),this.prepSidebarComponentsForDrag()}upload(t){const r=new d({Accept:"application/json, text/plain, */*","x-jwt-token":s.getToken()}),i=new FormData;i.append("file",t),h(`${this.projectUrl}/upload`,{method:"POST",headers:r,body:i}).then(t=>{201!==t.status?t.text().then(e=>{this.setUploadError(`${t.statusText} - ${e}`)}):t.json().then(t=>{e.set(this.webform.form,"settings.pdf",{id:t.file,src:`${t.filesServer}${t.path}`}),this.emit("pdfUploaded",t),this.redraw()})}).catch(()=>{this.setUploadError("Upload failed.")})}setUploadError(e){this.refs.uploadError&&(this.refs.uploadError.style.display=e?"":"none",this.refs.uploadError.innerHTML=e)}createForm(e){return e.skipInit=!1,this.webform=new a(this.element,e),this.webform.on("attach",()=>{this.refs.iframeDropzone&&![...this.refs.form.children].includes(this.refs.iframeDropzone)&&this.prependTo(this.refs.iframeDropzone,this.refs.form)}),this.webform}setForm(e){return super.setForm(e).then(()=>this.ready.then(()=>this.webform?(this.webform.postMessage({name:"form",data:e}),this.webform.setForm(e)):e))}saveComponent(...e){return super.saveComponent(...e).then(()=>this.afterAttach())}destroy(){super.destroy(),this.webform.destroy()}initIframeEvents(){this.webform.iframeElement&&(this.webform.off("iframe-elementUpdate"),this.webform.off("iframe-componentUpdate"),this.webform.off("iframe-componentClick"),this.webform.on("iframe-elementUpdate",e=>{const t=this.webform.getComponentById(e.id);return t&&t.component&&(t.component.overlay={page:e.page,left:e.left,top:e.top,height:e.height,width:e.width},this.editComponent(t.component,this.webform.iframeElement),this.emit("updateComponent",t)),t}),this.webform.on("iframe-componentUpdate",t=>{const r=this.webform.getComponentById(t.id);if(r&&r.component){r.component.overlay={page:t.overlay.page,left:t.overlay.left,top:t.overlay.top,height:t.overlay.height,width:t.overlay.width},this.emit("updateComponent",r);const s=e.find(this.form.components,{id:t.id});s&&(s.overlay=e.clone(r.component.overlay)),this.emit("change",this.form)}return r}),this.webform.on("iframe-componentClick",e=>{const t=this.webform.getComponentById(e.id);t&&this.editComponent(t.component,this.webform.iframeElement)},!0))}initDropzoneEvents(){this.refs.iframeDropzone&&(this.removeEventListener(this.refs.iframeDropzone,"dragover"),this.removeEventListener(this.refs.iframeDropzone,"drop"),this.addEventListener(this.refs.iframeDropzone,"dragover",e=>(e.preventDefault(),!1)),this.addEventListener(this.refs.iframeDropzone,"drop",this.onDropzoneDrop.bind(this)))}prepSidebarComponentsForDrag(){this.refs["sidebar-container"]&&this.refs["sidebar-container"].forEach(e=>{[...e.children].forEach(e=>{e.draggable=!0,e.setAttribute("draggable",!0),this.removeEventListener(e,"dragstart"),this.removeEventListener(e,"dragend"),this.addEventListener(e,"dragstart",this.onDragStart.bind(this),!0),this.addEventListener(e,"dragend",this.onDragEnd.bind(this),!0)})})}updateDropzoneDimensions(){if(!this.refs.iframeDropzone)return;const e=o.getElementRect(this.webform.refs.iframeContainer);this.refs.iframeDropzone.style.height=e&&e.height?`${e.height}px`:"1000px",this.refs.iframeDropzone.style.width=e&&e.width?`${e.width}px`:"100%"}tryUpdateCustomComponentSchema(t,r){const s=e.get(this,`groups.custom.components[${r}]`);return!!s&&(t.key=s.schema&&s.schema.key||t.key,t.label=s.schema&&s.schema.label||t.label,t.keyForShow=t.key,t.customField=!0,!0)}onDragStart(e){e.dataTransfer.setData("text/html",null),this.updateDropzoneDimensions(),this.addClass(this.refs.iframeDropzone,"enabled")}onDropzoneDrop(e){return this.dropEvent=e,e.preventDefault(),!1}onDragEnd(t){const r=this.dropEvent?this.dropEvent.offsetX:null,s=this.dropEvent?this.dropEvent.offsetY:null;if(this.removeClass(this.refs.iframeDropzone,"enabled"),!this.dropEvent)return;const i=t.target,a=i.getAttribute("data-type"),h=i.getAttribute("data-group"),d=i.getAttribute("data-key"),p=o.fastCloneDeep(this.schemas[a]);"custom"===h&&d&&this.tryUpdateCustomComponentSchema(p,d)||(p.key=e.camelCase(p.label||p.placeholder||p.type)),n.uniquify([this.webform.component],p),this.webform.component.components.push(p),this.emit("addComponent",p),p.overlay={top:s,left:r,width:100,height:20},this.webform.addComponent(p,{},null,!0),this.webform.postMessage({name:"addElement",data:p}),this.dropEvent=null}}});
//# sourceMappingURL=sourcemaps/PDFBuilder.js.map
