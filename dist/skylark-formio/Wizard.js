/**
 * skylark-formio - A version of formio.js that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-formio/
 * @license MIT
 */
define(["./vendors/getify/npo","skylark-lodash","./Webform","./Formio","./utils/utils"],function(e,t,s,i,n){"use strict";class a extends s{constructor(){let e,t;arguments[0]instanceof HTMLElement||arguments[1]?(e=arguments[0],t=arguments[1]):t=arguments[0],super(e,t),this.pages=[],this.prefixComps=[],this.suffixComps=[],this.components=[],this.originalComponents=[],this.page=0,this.currentNextPage=0,this._seenPages=[0]}isLastPage(){const e=this.getNextPage();return t.isNumber(e)?0<e&&e>=this.pages.length:t.isNull(e)}getPages(e={}){const{all:s=!1}=e;return this.pages.filter(s?t.identity:(e,t)=>this._seenPages.includes(t))}getComponents(){return this.submitting?this.getPages({all:this.isLastPage()}):super.getComponents()}resetValue(){this.getPages({all:!0}).forEach(e=>e.resetValue()),this.setPristine(!0)}init(){this.options.buttonSettings=t.defaults(this.options.buttonSettings,{showPrevious:!0,showNext:!0,showSubmit:!0,showCancel:!this.options.readOnly}),this.options.breadcrumbSettings=t.defaults(this.options.breadcrumbSettings,{clickable:!0}),this.page=0;const e=super.init();return this.setComponentSchema(),e}get wizardKey(){return`wizard-${this.id}`}get form(){return this.wizard}set form(e){super.form=e}get buttons(){const e={};return[{name:"cancel",method:"cancel"},{name:"previous",method:"prevPage"},{name:"next",method:"nextPage"},{name:"submit",method:"submit"}].forEach(t=>{this.hasButton(t.name)&&(e[t.name]=t)}),e}get renderContext(){return{wizardKey:this.wizardKey,isBreadcrumbClickable:this.isBreadcrumbClickable(),panels:this.pages.map(e=>e.component),buttons:this.buttons,currentPage:this.page}}render(){const e=this.renderContext;return this.renderTemplate("wizard",{...e,className:super.getClassName(),wizardHeader:this.renderTemplate("wizardHeader",e),wizardNav:this.renderTemplate("wizardNav",e),components:this.renderComponents([...this.prefixComps,...this.currentPage.components,...this.suffixComps])},this.builderMode?"builder":"form")}redrawNavigation(){if(this.element){let e=this.element.querySelector(`#${this.wizardKey}-nav`);e&&(this.detachNav(),e.outerHTML=this.renderTemplate("wizardNav",this.renderContext),e=this.element.querySelector(`#${this.wizardKey}-nav`),this.loadRefs(e,{[`${this.wizardKey}-cancel`]:"single",[`${this.wizardKey}-previous`]:"single",[`${this.wizardKey}-next`]:"single",[`${this.wizardKey}-submit`]:"single"}),this.attachNav())}}redrawHeader(){if(this.element){let e=this.element.querySelector(`#${this.wizardKey}-header`);e&&(this.detachHeader(),e.outerHTML=this.renderTemplate("wizardHeader",this.renderContext),e=this.element.querySelector(`#${this.wizardKey}-header`),this.loadRefs(e,{[`${this.wizardKey}-link`]:"multiple"}),this.attachHeader())}}attach(e){this.element=e,this.loadRefs(e,{[this.wizardKey]:"single",[`${this.wizardKey}-cancel`]:"single",[`${this.wizardKey}-previous`]:"single",[`${this.wizardKey}-next`]:"single",[`${this.wizardKey}-submit`]:"single",[`${this.wizardKey}-link`]:"multiple"});const t=this.attachComponents(this.refs[this.wizardKey],[...this.prefixComps,...this.currentPage.components,...this.suffixComps]);return this.attachNav(),this.attachHeader(),t.then(()=>this.emit("render"))}isBreadcrumbClickable(){return t.get(this.options,"breadcrumbSettings.clickable",!0)}attachNav(){t.each(this.buttons,e=>{const t=this.refs[`${this.wizardKey}-${e.name}`];this.addEventListener(t,"click",s=>{s.preventDefault(),t.setAttribute("disabled","disabled"),this.setLoading(t,!0),this[e.method]().then(()=>{t.removeAttribute("disabled"),this.setLoading(t,!1)}).catch(()=>{t.removeAttribute("disabled"),this.setLoading(t,!1)})})})}attachHeader(){this.isBreadcrumbClickable()&&this.refs[`${this.wizardKey}-link`].forEach((e,t)=>{this.addEventListener(e,"click",e=>(this.emit("wizardNavigationClicked",this.pages[t]),e.preventDefault(),this.setPage(t).then(()=>{this.emit("wizardPageSelected",this.pages[t],t)})))})}detachNav(){t.each(this.buttons,e=>{this.removeEventListener(this.refs[`${this.wizardKey}-${e.name}`],"click")})}detachHeader(){this.refs[`${this.wizardKey}-link`].forEach(e=>{this.removeEventListener(e,"click")})}establishPages(){this.pages=[],this.prefixComps=[],this.suffixComps=[];const e=[],s={},i=t.clone(this.options);return this.components&&this.components.length&&this.components.map(e=>{"panel"===e.component.type&&(s[e.component.key||e.component.title]=e)}),this.originalComponents&&this.originalComponents.forEach(t=>{if("panel"===t.type){t.key||(t.key=t.title);let a=s[t.key];const r=n.checkCondition(t,this.data,this.data,this.component,this);r&&(e.push(t),a&&this.pages.push(a)),!a&&r?(a=this.createComponent(t,i),this.pages.push(a),a.eachComponent(e=>{e.page=this.pages.length-1})):a&&!r&&this.removeComponent(a)}else"button"!==t.type&&(this.pages.length?this.suffixComps.push(this.createComponent(t,i)):this.prefixComps.push(this.createComponent(t,i)))}),e}addComponents(){this.establishPages()}setPage(t){return t===this.page?e.resolve():!this.wizard.full&&t>=0&&t<this.pages.length?(this.page=t,this.pageFieldLogic(t),this.getNextPage(),this._seenPages.includes(t)||(this._seenPages=this._seenPages.concat(t)),this.redraw().then(()=>{this.options.readOnly||this.checkValidity(this.submission.data,!1,this.submission.data,!0)}),e.resolve()):this.wizard.full||!this.pages.length?(this.redraw(),e.resolve()):e.reject("Page not found")}pageFieldLogic(e){this.component=this.pages[e].component,this.originalComponent=n.fastCloneDeep(this.component),this.fieldLogic(this.data),this.disabled=this.shouldDisabled}get currentPage(){return this.pages&&this.pages.length>=this.page?this.pages[this.page]:{components:[]}}getNextPage(){const e=this.submission.data,t=this.pages[this.page].component;if(t){const s=this.pages.length>this.page+1?this.page+1:-1;if(t.nextPage){const i=this.evaluate(t.nextPage,{next:s,data:e,page:s,form:t},"next");if(null===i)return this.currentNextPage=null,null;const n=parseInt(i,10);return!isNaN(parseInt(n,10))&&isFinite(n)?(this.currentNextPage=n,n):(this.currentNextPage=this.getPageIndexByKey(i),this.currentNextPage)}return this.currentNextPage=s,s}return this.currentNextPage=null,null}getPreviousPage(){return this.page-1}beforeSubmit(){return e.all(this.getPages().map(e=>(e.options.beforeSubmit=!0,e.beforeSubmit())))}beforePage(t){return new e((e,s)=>{this.hook(t?"beforeNext":"beforePrev",this.currentPage,this.submission,i=>{i&&(this.showErrors(i,!0),s(i));const n=this.currentPage;n?n.beforePage(t).then(e).catch(s):e()})})}nextPage(){return this.options.readOnly?this.setPage(this.getNextPage()).then(()=>{this.emit("nextPage",{page:this.page,submission:this.submission})}):this.checkValidity(this.submission.data,!0,this.submission.data,!0)?(this.checkData(this.submission.data),this.beforePage(!0).then(()=>this.setPage(this.getNextPage()).then(()=>{this.emit("nextPage",{page:this.page,submission:this.submission})}))):(this.currentPage.components.forEach(e=>e.setPristine(!1)),e.reject(this.showErrors([],!0)))}prevPage(){return this.beforePage().then(()=>this.setPage(this.getPreviousPage()).then(()=>{this.emit("prevPage",{page:this.page,submission:this.submission})}))}cancel(t){return super.cancel(t)?(this.setPristine(!0),this.setPage(0).then(()=>(this.redraw(),this.page))):e.resolve()}getPageIndexByKey(e){let t=this.page;return this.pages.forEach((s,i)=>{if(s.component.key===e)return t=i,!1}),t}get schema(){return this.wizard}setComponentSchema(){const e={};if(this.originalComponents=[],this.component.components.map(s=>{"panel"===s.type&&(s.key=n.uniqueKey(e,s.key||"panel"),e[s.key]=!0),this.originalComponents.push(t.clone(s))}),!Object.keys(e).length){const e={type:"panel",title:"Page 1",label:"Page 1",key:"page1",components:this.component.components};this.component.components=[e],this.originalComponents.push(t.clone(e))}}setForm(e){if(e)return this.wizard=e,this.component.components=e.components||[],this.setComponentSchema(),super.setForm(e)}setValue(e,t={}){const s=super.setValue(e,t);return this.pageFieldLogic(this.page),s}isClickable(e,s){return this.page!==s&&n.firstNonNil([t.get(e,"breadcrumbClickable"),this.options.breadcrumbSettings.clickable])}hasButton(e,s){const i=this.currentPage;if("previous"===e){const e=n.firstNonNil([t.get(i,"buttonSettings.previous"),this.options.buttonSettings.showPrevious]);return this.getPreviousPage()>-1&&e}if(s=void 0===s?this.getNextPage():s,"next"===e){const e=n.firstNonNil([t.get(i,"buttonSettings.next"),this.options.buttonSettings.showNext]);return null!==s&&-1!==s&&e}if("cancel"===e)return n.firstNonNil([t.get(i,"buttonSettings.cancel"),this.options.buttonSettings.showCancel]);if("submit"===e){return n.firstNonNil([t.get(i,"buttonSettings.submit"),this.options.buttonSettings.showSubmit])&&!this.options.readOnly&&(null===s||this.page===this.pages.length-1)}return!0}pageId(e){return e.key?`${e.key}-${e.title}`:e.components&&e.components.length>0?this.pageId(e.components[0]):e.title}onChange(e,s,i){super.onChange(e,s,i),this.alert&&!this.submitted&&(this.checkValidity(this.submission.data,!1,this.submission.data,!0),this.showErrors([],!0));const n=this.pages.map(e=>e.component.key),a=this.establishPages().map(e=>e.key),r=this.currentNextPage;t.isEqual(a,n)||this.redrawHeader(),r!==this.getNextPage()&&this.redrawNavigation()}checkValidity(e,t,s,i){if(!this.checkCondition(s,e))return this.setCustomValidity(""),!0;return(!i||this.isLastPage()?this.getComponents():this.currentPage.components).reduce((i,n)=>n.checkValidity(e,t,s)&&i,!0)}get errors(){return this.isLastPage()?super.errors:this.currentPage.errors}focusOnComponent(e){let t=0;const[s]=this.pages.filter((s,i)=>!!s.getComponent(e)&&(t=i,!0));return s&&s!==this.currentPage?this.setPage(t).then(()=>{this.checkValidity(this.submission.data,!0,this.submission.data),this.showErrors(),super.focusOnComponent(e)}):super.focusOnComponent(e)}}return a.setBaseUrl=i.setBaseUrl,a.setApiUrl=i.setApiUrl,a.setAppUrl=i.setAppUrl,a});
//# sourceMappingURL=sourcemaps/Wizard.js.map
