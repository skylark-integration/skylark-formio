/**
 * skylark-formio - A version of formio.js that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-formio/
 * @license MIT
 */
define(["skylark-lodash","../field/Field","../../Components","../../../vendors/getify/npo"],function(e,t,n,s){"use strict";class o extends t{static schema(...e){return t.schema({tree:!1},...e)}constructor(e,t,n){super(e,t,n),this.type="components",this._collapsed=!!this.component.collapsed}get defaultSchema(){return o.schema()}get schema(){const t=super.schema,n=e.uniqBy(this.getComponents(),"component.key");return t.components=e.map(n,"schema"),t}get collapsed(){return this._collapsed}set collapsed(e){this._collapsed=e,this.redraw()}set visible(e){super.visible=e;const t=this.visible,n=this.options.show&&this.options.show[this.component.key],s=this.options.hide&&this.options.hide[this.component.key];this.components.forEach(e=>{const o=e.conditionallyVisible();n||o?e.visible=!0:!s&&t&&o||(e.visible=!1),e.visible||(e.error=""),e.parentVisible=t})}get visible(){return super.visible}set parentVisible(e){super.parentVisible=e,this.components.forEach(e=>{e.parentVisible=this.visible})}get parentVisible(){return super.parentVisible}get disabled(){return super.disabled}set disabled(e){super.disabled=e,this.components.forEach(t=>t.parentDisabled=e)}set parentDisabled(e){super.parentDisabled=e,this.components.forEach(e=>{e.parentDisabled=this.disabled})}get parentDisabled(){return super.parentDisabled}get ready(){return s.all(this.getComponents().map(e=>e.ready))}get currentForm(){return super.currentForm}set currentForm(e){super.currentForm=e,this.getComponents().forEach(t=>{t.currentForm=e})}get rowIndex(){return this._rowIndex}set rowIndex(e){this._rowIndex=e,this.eachComponent(t=>{t.rowIndex=e})}componentContext(){return this._data}get data(){return this._data}set data(e){this._data=e,this.eachComponent(e=>{e.data=this.componentContext(e)})}getComponents(){return this.components||[]}everyComponent(t){const n=this.getComponents();e.each(n,(e,s)=>!1!==t(e,n,s)&&(("function"!=typeof e.everyComponent||!1!==e.everyComponent(t))&&void 0))}hasComponent(e){let t=!1;return this.everyComponent(n=>{if(n===e)return t=!0,!1}),t}flattenComponents(){const e={};return this.everyComponent(t=>{e[t.component.flattenAs||t.key]=t}),e}eachComponent(t){e.each(this.getComponents(),(e,n)=>{if(!1===t(e,n))return!1})}getComponent(t,n){t=Array.isArray(t)?t:[t];const[s,...o]=t;let i=null;return e.isString(s)?(this.everyComponent((e,t)=>{if(e.component.key===s)return i=e,o.length>0&&"getComponent"in e?i=e.getComponent(o,n):n&&n(e,t),!1}),i):i}getComponentById(e,t){let n=null;return this.everyComponent((s,o)=>{if(s.id===e)return n=s,t&&t(s,o),!1}),n}createComponent(t,s,o,i){if(!t)return;s=s||this.options,o=o||this.data,s.parent=this,s.parentVisible=this.visible,s.root=this.root||this,s.skipInit=!0;const r=n.create(t,s,o,!0);if(t.key){let e=this;for(;e&&!e.allowData&&e.parent;)e=e.parent;r.path=e.path?`${e.path}.`:"",r.path+=t.key}if(r.init(),t.internal)return r;if(i){const t=e.findIndex(this.components,{id:i.id});-1!==t?this.components.splice(t,0,r):this.components.push(r)}else this.components.push(r);return r}getContainer(){return this.element}get componentComponents(){return this.component.components||[]}get nestedKey(){return`nested-${this.key}`}get templateName(){return"container"}init(){return this.components=this.components||[],this.addComponents(),super.init()}addComponents(e,t){if(e=e||this.data,(t=t||this.options).components)this.components=t.components;else{(this.hook("addComponents",this.componentComponents,this)||[]).forEach(t=>this.addComponent(t,e))}}addComponent(e,t,n,s){t=t||this.data,e=this.hook("addComponent",e,t,n,s);const o=this.createComponent(e,this.options,t,n||null);return o}render(e){return super.render(e||this.renderTemplate(this.templateName,{children:this.renderComponents(),nestedKey:this.nestedKey,collapsed:this.collapsed}))}renderComponents(e){const t=(e=e||this.getComponents()).map(e=>e.render());return this.renderTemplate("components",{children:t,components:e})}attach(e){const t=super.attach(e);this.loadRefs(e,{header:"single",collapsed:this.collapsed,[this.nestedKey]:"single"});let n=s.resolve();return this.refs[this.nestedKey]&&(n=this.attachComponents(this.refs[this.nestedKey])),this.component.collapsible&&this.refs.header&&this.addEventListener(this.refs.header,"click",()=>{this.collapsed=!this.collapsed}),s.all([t,n])}attachComponents(e,t,n){if(t=t||this.components,n=n||this.component.components,!(e=this.hook("attachComponents",e,t,n,this)))return new s(()=>{});let o=0;const i=[];return Array.prototype.slice.call(e.children).forEach(e=>{!e.getAttribute("data-noattach")&&t[o]&&(i.push(t[o].attach(e)),o++)}),s.all(i)}removeComponent(t,n){n=n||this.components,t.destroy(),e.remove(n,{id:t.id})}removeComponentByKey(e,t){if(!this.getComponent(e,(e,n)=>{this.removeComponent(e,n),t&&t(e,n)}))return t&&t(null),null}removeComponentById(e,t){if(!this.getComponentById(e,(e,n)=>{this.removeComponent(e,n),t&&t(e,n)}))return t&&t(null),null}updateValue(e,t={}){return this.components.reduce((e,n)=>n.updateValue(null,t)||e,super.updateValue(e,t))}shouldSkipValidation(e,t,n){return!this.component.input||super.shouldSkipValidation(e,t,n)}checkData(e,t,n,s){return!!this.builderMode||(e=e||this.rootValue,t=t||{},n=n||this.data,(s=s||this.getComponents()).reduce((s,o)=>o.checkData(e,t,n)&&s,super.checkData(e,t,n)))}checkConditions(e,t,n){return this.getComponents().forEach(s=>s.checkConditions(e,t,n)),super.checkConditions(e,t,n)}clearOnHide(e){super.clearOnHide(e),this.component.clearOnHide&&(this.allowData&&!this.hasValue()&&(this.dataValue=this.defaultValue),this.hasValue()&&this.restoreComponentsContext()),this.getComponents().forEach(t=>t.clearOnHide(e))}restoreComponentsContext(){this.getComponents().forEach(e=>e.data=this.dataValue)}beforePage(e){return s.all(this.getComponents().map(t=>t.beforePage(e)))}beforeSubmit(){return s.all(this.getComponents().map(e=>e.beforeSubmit()))}calculateValue(e,t,n){return!!this.conditionallyVisible()&&this.getComponents().reduce((s,o)=>o.calculateValue(e,t,n)||s,super.calculateValue(e,t,n))}isLastPage(){return this.pages.length-1===this.page}isValid(e,t){return this.getComponents().reduce((n,s)=>s.isValid(e,t)&&n,super.isValid(e,t))}checkValidity(e,t,n){return this.checkCondition(n,e)?this.getComponents().reduce((s,o)=>o.checkValidity(e,t,n)&&s,super.checkValidity(e,t,n)):(this.setCustomValidity(""),!0)}checkAsyncValidity(e,t,n){const o=[super.checkAsyncValidity(e,t,n)];return this.eachComponent(s=>o.push(s.checkAsyncValidity(e,t,n))),s.all(o).then(e=>e.reduce((e,t)=>e&&t,!0))}setPristine(e){super.setPristine(e),this.getComponents().forEach(t=>t.setPristine(e))}detach(){this.components.forEach(e=>{e.detach()}),super.detach()}destroy(){this.destroyComponents(),super.destroy()}destroyComponents(){this.getComponents().slice().forEach(e=>this.removeComponent(e,this.components)),this.components=[]}get errors(){const e=this.error?[this.error]:[];return this.getComponents().reduce((e,t)=>e.concat(t.errors||[]),e)}getValue(){return this.data}resetValue(){this.getComponents().forEach(e=>e.resetValue()),this.unset(),this.setPristine(!0)}get dataReady(){return s.all(this.getComponents().map(e=>e.dataReady))}setNestedValue(t,n,s={}){return t._data=this.componentContext(t),"button"!==t.type&&("components"===t.type?t.setValue(n,s):n&&t.hasValue(n)?t.setValue(e.get(n,t.key),s):!this.rootPristine||t.visible?(s.noValidate=!s.dirty,s.resetValue=!0,t.setValue(t.defaultValue,s)):void 0)}setValue(e,t={}){return!!e&&this.getComponents().reduce((n,s)=>this.setNestedValue(s,e,t,n)||n,!1)}}return n.NestedComponent=o,o});
//# sourceMappingURL=../../../sourcemaps/components/_classes/nested/NestedComponent.js.map
