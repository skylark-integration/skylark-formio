/**
 * skylark-formio - A version of formio.js that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-formio/
 * @license MIT
 */
define(["skylark-lodash","../_classes/component/Component","../../vendors/eventemitter2/EventEmitter2","../../vendors/getify/npo","../../utils/utils","../../Formio","../../Form"],function(t,e,s,o,i,r,n){"use strict";return class a extends e{static schema(...t){return e.schema({label:"Form",type:"form",key:"form",src:"",reference:!0,form:"",path:"",tableView:!0},...t)}static get builderInfo(){return{title:"Nested Form",icon:"wpforms",group:"premium",documentation:"http://help.form.io/userguide/#form",weight:110,schema:a.schema()}}init(){if(super.init(),this.formObj={display:this.component.display,settings:this.component.settings,components:this.component.components},this.subForm=null,this.formSrc="",this.component.src&&(this.formSrc=this.component.src),this.component.src||this.options.formio||!this.component.form&&!this.component.path||(this.component.project?(this.formSrc=r.getBaseUrl(),i.isMongoId(this.component.project)&&(this.formSrc+="/project"),this.formSrc+=`/${this.component.project}`,this.options.project=this.formSrc):(this.formSrc=r.getProjectUrl(),this.options.project=this.formSrc),this.component.form?this.formSrc+=`/form/${this.component.form}`:this.component.path&&(this.formSrc+=`/${this.component.path}`)),!this.formSrc&&this.options.formio){const t=this.options.formio.formsUrl;if(this.component.path){const e=t.split("/");e.pop(),this.formSrc=`${e.join("/")}/${this.component.path}`}this.component.form&&(this.formSrc=`${t}/${this.component.form}`)}(this.component.revision||0===this.component.revision)&&(this.formSrc+=`/v/${this.component.revision}`)}get dataReady(){return this.subFormReady||o.resolve()}get defaultValue(){return this.subForm?super.defaultValue:null}get defaultSchema(){return a.schema()}get emptyValue(){return{data:{}}}get ready(){return this.subFormReady||o.resolve()}getSubOptions(e={}){return this.options?(this.options.base&&(e.base=this.options.base),this.options.project&&(e.project=this.options.project),this.options.readOnly&&(e.readOnly=this.options.readOnly),this.options.breadcrumbSettings&&(e.breadcrumbSettings=this.options.breadcrumbSettings),this.options.buttonSettings&&(e.buttonSettings=t.clone(this.options.buttonSettings)),this.options.viewAsHtml&&(e.viewAsHtml=this.options.viewAsHtml),this.options.language&&(e.language=this.options.language),this.options.template&&(e.template=this.options.template),this.options.templates&&(e.templates=this.options.templates),this.options.renderMode&&(e.renderMode=this.options.renderMode),this.options.attachMode&&(e.attachMode=this.options.attachMode),this.options.iconset&&(e.iconset=this.options.iconset),e.events=this.createEmitter(),t.set(e,"buttonSettings.showSubmit",!1),e):e}render(){if(this.builderMode)return super.render(this.component.label||"Nested form");const t=this.subForm?this.subForm.render():this.renderTemplate("loading");return super.render(t)}asString(t){return this.getValueAsString(t)}getValueAsString(t){return t?!t.data&&t._id?t._id:t.data&&Object.keys(t.data).length?"[Complex Data]":"No data provided":"No data provided"}attach(t){return this.builderMode?super.attach(t):super.attach(t).then(()=>this.createSubForm()).then(()=>{this.empty(t),this.options.builder?this.setContent(t,this.ce("div",{class:"text-muted text-center p-2"},this.text(this.formObj.title))):(this.setContent(t,this.render()),this.subForm&&this.subForm.attach(t))})}detach(){this.subForm&&this.subForm.detach(),super.detach()}get currentForm(){return this._currentForm}set currentForm(t){this._currentForm=t,this.subForm&&this.subForm.getComponents().forEach(t=>{t.currentForm=this})}destroy(){this.subForm&&(this.subForm.destroy(),this.subForm=null,this.subFormReady=null),super.destroy()}redraw(){return this.subForm&&(this.subForm.form=this.formObj),super.redraw()}everyComponent(...t){this.subForm&&this.subForm.everyComponent(...t)}createSubForm(){return this.subFormReady=this.loadSubForm().then(t=>{if(t)return i.eachComponent(t.components,t=>{"button"!==t.type||"submit"!==t.action&&t.action||(t.hidden=!0)}),this.subForm&&this.subForm.destroy(),new n(t,this.getSubOptions()).ready.then(t=>(this.subForm=t,this.subForm.currentForm=this,this.subForm.parent=this,this.subForm.parentVisible=this.visible,this.subForm.on("change",()=>{this.subForm&&(this.dataValue=this.subForm.getValue(),this.triggerChange({noEmit:!0}))}),this.subForm.url=this.formSrc,this.subForm.nosubmit=!0,this.subForm.root=this.root,this.restoreValue(),this.subForm))}),this.subFormReady}loadSubForm(){return this.builderMode||this.isHidden()?o.resolve():this.formObj&&this.formObj.components&&Array.isArray(this.formObj.components)&&this.formObj.components.length?(this.root&&this.root.form&&this.root.form.config&&!this.formObj.config&&(this.formObj.config=this.root.form.config),o.resolve(this.formObj)):this.formSrc?new r(this.formSrc).loadForm({params:{live:1}}).then(t=>(this.formObj=t,t)):o.resolve()}checkComponentValidity(t,e,s){return this.subForm?this.subForm.checkValidity(this.dataValue.data,e):super.checkComponentValidity(t,e,s)}checkComponentConditions(t,e,s){const o=super.checkComponentConditions(t,e,s);return o&&this.subForm&&this.subForm.hasCondition()?this.subForm.checkConditions(this.dataValue.data):o}calculateValue(t,e,s){return this.subForm?this.subForm.calculateValue(this.dataValue.data,e):super.calculateValue(t,e,s)}setPristine(t){super.setPristine(t),this.subForm&&this.subForm.setPristine(t)}get shouldSubmit(){return this.subFormReady&&(!this.component.hasOwnProperty("reference")||this.component.reference)&&!this.isHidden()}getSubFormData(){return"pdf"===t.get(this.subForm,"form.display")?this.subForm.getSubmission():o.resolve(this.dataValue)}submitSubForm(t){if(this.shouldSubmit){return(this.subFormReady||this.createSubForm()).then(()=>this.subForm?(this.subForm.nosubmit=!1,this.subForm.submitForm().then(t=>(this.subForm.loading=!1,this.dataValue=t.submission,this.dataValue)).catch(e=>t?(this.subForm.onSubmissionError(e),o.reject(e)):{})):this.dataValue)}return this.getSubFormData()}beforePage(t){return this.submitSubForm(!0).then(()=>super.beforePage(t))}beforeSubmit(){const t=this.dataValue;return t&&t._id&&t.form?(this.dataValue=t,o.resolve(this.dataValue)):this.submitSubForm(!1).then(()=>this.dataValue).then(()=>super.beforeSubmit())}isHidden(){return!this.visible||!super.checkConditions(this.rootValue)}setValue(e,s={}){const o=super.setValue(e,s);if(this.subForm)if(e&&e._id&&this.subForm.formio&&t.isEmpty(e.data)){const t=`${this.subForm.formio.formsUrl}/${e.form}/submission/${e._id}`;this.subForm.setUrl(t,this.options),this.subForm.loadSubmission()}else this.subForm.setValue(e,s);return o}getValue(){return this.subForm?this.subForm.getValue():this.dataValue}get errors(){let t=super.errors;return this.subForm&&(t=t.concat(this.subForm.errors)),t}updateSubFormVisibility(){this.subForm&&(this.subForm.parentVisible=this.visible)}get visible(){return super.visible}set visible(t){super.visible=t,this.updateSubFormVisibility()}get parentVisible(){return super.parentVisible}set parentVisible(t){super.parentVisible=t,this.updateSubFormVisibility()}isInternalEvent(t){switch(t){case"focus":case"blur":case"componentChange":case"componentError":case"error":case"formLoad":case"languageChanged":case"render":case"checkValidity":case"initialized":case"submit":case"submitButton":case"nosubmit":case"updateComponent":case"submitDone":case"submissionDeleted":case"requestDone":case"nextPage":case"prevPage":case"wizardNavigationClicked":case"updateWizardNav":case"restoreDraft":case"saveDraft":case"saveComponent":case"pdfUploaded":return!0;default:return!1}}createEmitter(){const t=new s({wildcard:!1,maxListeners:0}),e=t.emit,o=this;return t.emit=function(t,...s){const i=t.replace(`${o.options.namespace}.`,"");e.call(this,t,...s),o.isInternalEvent(i)||o.emit(i,...s)},t}deleteValue(){super.setValue(null,{noUpdateEvent:!0,noDefault:!0}),this.unset()}}});
//# sourceMappingURL=../../sourcemaps/components/form/Form.js.map
