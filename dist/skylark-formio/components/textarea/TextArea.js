/**
 * skylark-formio - A version of formio.js that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-formio/
 * @license MIT
 */
define(["../textfield/TextField","skylark-lodash","../../vendors/getify/npo","../../utils/utils"],function(e,t,i,s){"use strict";return class n extends e{static schema(...t){return e.schema({type:"textarea",label:"Text Area",key:"textArea",rows:3,wysiwyg:!1,editor:"",inputFormat:"html",validate:{minWords:"",maxWords:""}},...t)}static get builderInfo(){return{title:"Text Area",group:"basic",icon:"font",documentation:"http://help.form.io/userguide/#textarea",weight:20,schema:n.schema()}}init(){super.init(),this.editors=[],this.editorsReady=[],this.updateSizes=[],this.options.submitOnEnter=!1}get defaultSchema(){return n.schema()}get inputInfo(){const e=super.inputInfo;return e.type=this.component.wysiwyg?"div":"textarea",this.component.rows&&(e.attr.rows=this.component.rows),e}validateMultiple(){return!this.isJsonValue}renderElement(e,t){const i=this.inputInfo;return i.attr=i.attr||{},i.content=e,this.options.readOnly||this.disabled?this.renderTemplate("well",{children:'<div ref="input"></div>',nestedKey:this.key,value:e}):this.component.editor||this.component.wysiwyg?'<div ref="input"></div>':this.renderTemplate("input",{input:i,value:e,index:t})}get autoExpand(){return this.component.autoExpand}updateEditorValue(e,i){i=this.getConvertedValue(this.removeBlanks(i));const s=this.dataValue;if(this.component.multiple&&Array.isArray(s)){const n=t.clone(s);n[e]=i,i=n}t.isEqual(i,s)||t.isEmpty(i)&&t.isEmpty(s)||this.updateValue(i,{modified:!this.autoModified}),this.autoModified=!1}attachElement(e,s){if(this.autoExpand&&(this.isPlain||this.options.readOnly||this.options.htmlView)&&"TEXTAREA"===e.nodeName&&this.addAutoExpanding(e,s),this.options.readOnly)return e;this.component.wysiwyg&&!this.component.editor&&(this.component.editor="ckeditor");let n=t.isEmpty(this.component.wysiwyg)?this.wysiwygDefault[this.component.editor]||this.wysiwygDefault.default:this.component.wysiwyg;return this.editorsReady[s]=new i(i=>{switch(this.component.editor){case"ace":n||(n={}),n.mode=this.component.as,this.addAce(e,n,e=>this.updateEditorValue(s,e)).then(e=>{this.editors[s]=e;let t=this.dataValue;return t=this.component.multiple&&Array.isArray(t)?t[s]:t,e.setValue(this.setConvertedValue(t,s)),i(e),e}).catch(e=>console.warn(e));break;case"quill":(n.hasOwnProperty("toolbarGroups")||n.hasOwnProperty("toolbar"))&&(console.warn("The WYSIWYG settings are configured for CKEditor. For this renderer, you will need to use configurations for the Quill Editor. See https://quilljs.com/docs/configuration for more information."),n=this.wysiwygDefault.quill),this.addQuill(e,n,()=>this.updateEditorValue(s,this.editors[s].root.innerHTML)).then(e=>{if(this.editors[s]=e,this.component.isUploadEnabled){const t=this;e.getModule("toolbar").addHandler("image",function(){t.imageHandler.call(t,this)})}e.root.spellcheck=this.component.spellcheck,(this.options.readOnly||this.component.disabled)&&e.disable();let t=this.dataValue;return t=this.component.multiple&&Array.isArray(t)?t[s]:t,e.setContents(e.clipboard.convert(this.setConvertedValue(t,s))),i(e),e}).catch(e=>console.warn(e));break;case"ckeditor":(n=n||{}).rows=this.component.rows,this.addCKE(e,n,e=>this.updateEditorValue(s,e)).then(e=>{this.editors[s]=e,(this.options.readOnly||this.component.disabled)&&(e.isReadOnly=!0);const n=parseInt(this.component.rows,10);if(t.isFinite(n)&&t.has(e,"ui.view.editable.editableElement")){const t=31*n+14;e.ui.view.editable.editableElement.style.height=`${t}px`}let o=this.dataValue;return o=this.component.multiple&&Array.isArray(o)?o[s]:o,e.data.set(this.setConvertedValue(o,s)),i(e),e});break;case"tiny":n||(n={}),n.mode=this.component.as||"javascript",this.addTiny(e,n,e=>this.updateEditorValue(e)).then(e=>(this.editors[s]=e,e.setContent(this.setConvertedValue(this.dataValue)),i(e),e)).catch(e=>console.warn(e));break;default:super.attachElement(e,s)}}),e}attach(e){const t=super.attach(e);return this.restoreValue(),t}imageHandler(e){let t=e.container.querySelector("input.ql-image[type=file]");null==t&&((t=document.createElement("input")).setAttribute("type","file"),t.setAttribute("accept","image/*"),t.classList.add("ql-image"),this.addEventListener(t,"change",()=>{const i=t.files,n=e.quill.getSelection(!0);if(!i||!i.length)return void console.warn("No files selected");e.quill.enable(!1);const{uploadStorage:o,uploadUrl:r,uploadOptions:a,uploadDir:l,fileKey:d}=this.component;let h;this.root.formio.uploadFile(o,i[0],s.uniqueName(i[0].name),l||"",null,r,a,d).then(e=>(h=e,this.root.formio.downloadFile(e))).then(i=>{e.quill.enable(!0);const s=Quill.import("delta");e.quill.updateContents((new s).retain(n.index).delete(n.length).insert({image:i.url},{alt:JSON.stringify(h)}),Quill.sources.USER),t.value=""}).catch(t=>{console.warn("Quill image upload failed"),console.warn(t),e.quill.enable(!0)})}),e.container.appendChild(t)),t.click()}get isPlain(){return!this.component.wysiwyg&&!this.component.editor}get htmlView(){return this.options.readOnly&&(this.component.editor||this.component.wysiwyg)}setValueAt(e,i,s={}){if(super.setValueAt(e,i,s),this.editorsReady[e]){const n=t=>s=>{if(this.autoModified=!0,!t.skipWysiwyg)switch(this.component.editor){case"ace":s.setValue(this.setConvertedValue(i,e));break;case"quill":this.component.isUploadEnabled?this.setAsyncConvertedValue(i).then(e=>{s.setContents(s.clipboard.convert(e))}):s.setContents(s.clipboard.convert(this.setConvertedValue(i,e)));break;case"ckeditor":s.data.set(this.setConvertedValue(i,e));break;case"tiny":s.setContent(this.setConvertedValue(i))}};this.editorsReady[e].then(n(t.clone(s)))}}setValue(e,i={}){return this.isPlain||this.options.readOnly||this.disabled?(e=this.component.multiple&&Array.isArray(e)?e.map((e,t)=>this.setConvertedValue(e,t)):this.setConvertedValue(e),super.setValue(e,i)):(i.skipWysiwyg=t.isEqual(e,this.getValue()),super.setValue(e,i))}setReadOnlyValue(e,t){t=t||0,(this.options.readOnly||this.disabled)&&this.refs.input&&this.refs.input[t]&&this.setContent(this.refs.input[t],this.interpolate(e))}get isJsonValue(){return this.component.as&&"json"===this.component.as}setConvertedValue(e,i){if(this.isJsonValue&&!t.isNil(e))try{e=JSON.stringify(e,null,2)}catch(e){console.warn(e)}return t.isString(e)||(e=""),this.setReadOnlyValue(e,i),e}setAsyncConvertedValue(e){if(this.isJsonValue&&e)try{e=JSON.stringify(e,null,2)}catch(e){console.warn(e)}t.isString(e)||(e="");const s=(new DOMParser).parseFromString(e,"text/html"),n=s.getElementsByTagName("img");return n.length?this.setImagesUrl(n).then(()=>(e=s.getElementsByTagName("body")[0].firstElementChild,(new XMLSerializer).serializeToString(e))):i.resolve(e)}setImagesUrl(e){return i.all(t.map(e,e=>{let t;try{t=JSON.parse(e.getAttribute("alt"))}catch(e){console.warn(e)}return this.root.formio.downloadFile(t).then(t=>{e.setAttribute("src",t.url)})}))}addAutoExpanding(e,i){let s=null,n=null;const o=t=>{const i=e.style.width;e.style.width="0px",e.offsetWidth,e.style.width=i,e.style.overflowY=t},r=()=>{0!==e.scrollHeight&&((e,t)=>{const i=[];for(;e&&e.parentNode&&e.parentNode instanceof Element;)e.parentNode.scrollTop&&i.push({node:e.parentNode,scrollTop:e.parentNode.scrollTop}),e=e.parentNode;t(),i.forEach(e=>{e.node.scrollTop=e.scrollTop})})(e,()=>{e.style.height="",e.style.height=`${e.scrollHeight+s}px`})},a=t.debounce(()=>{r();const t=Math.round(parseFloat(e.style.height)),i=window.getComputedStyle(e,null);let s=e.offsetHeight;s<t&&"hidden"===i.overflowY?o("scroll"):"hidden"!==i.overflowY&&o("hidden"),r(),s=e.offsetHeight,n!==s&&(n=s,a())},200),l=window.getComputedStyle(e,null);e.style.resize="none",s=parseFloat(l.borderTopWidth)+parseFloat(l.borderBottomWidth)||0,window&&this.addEventListener(window,"resize",a),this.addEventListener(e,"input",a),this.on("initialized",a),this.updateSizes[i]=a,a()}removeBlanks(e){if(!e)return e;const t=function(e){return"string"!=typeof e?e:e.replace(/<p>&nbsp;<\/p>|<p><br><\/p>|<p><br>&nbsp;<\/p>/g,"").trim()};return Array.isArray(e)?e.forEach((i,s)=>{e[s]=t(i)}):e=t(e),e}onChange(e,t){const i=super.onChange(e,t);return this.updateSizes.forEach(e=>e()),i}hasChanged(e,t){return super.hasChanged(this.removeBlanks(e),this.removeBlanks(t))}isEmpty(e=this.dataValue){return super.isEmpty(this.removeBlanks(e))}get defaultValue(){let e=super.defaultValue;return"quill"!==this.component.editor||e||(e="<p><br></p>"),e}getConvertedValue(e){if(this.isJsonValue&&e)try{e=JSON.parse(e)}catch(e){}return e}detach(){this.editors.forEach(e=>{e.destroy&&e.destroy()}),this.editors=[],this.editorsReady=[],this.updateSizes.forEach(e=>this.removeEventListener(window,"resize",e)),this.updateSizes=[]}getValue(){return this.isPlain?this.getConvertedValue(super.getValue()):this.dataValue}}});
//# sourceMappingURL=../../sourcemaps/components/textarea/TextArea.js.map
