/**
 * skylark-formio - A version of formio.js that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-formio/
 * @license MIT
 */
define(["../_classes/field/Field","../../utils/utils","../../vendors/downloadjs/download","skylark-lodash","../../Formio","../../vendors/getify/npo"],function(e,t,i,s,r,a){"use strict";let o=navigator.camera||void 0;return HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(e,t,i){var s=this;setTimeout(function(){for(var r=atob(s.toDataURL(t,i).split(",")[1]),a=r.length,o=new Uint8Array(a),n=0;n<a;n++)o[n]=r.charCodeAt(n);e(new Blob([o],{type:t||"image/png"}))})}}),class n extends e{static schema(...t){return e.schema({type:"file",label:"Upload",key:"file",image:!1,privateDownload:!1,imageSize:"200",filePattern:"*",fileMinSize:"0KB",fileMaxSize:"1GB",uploadOnly:!1},...t)}static get builderInfo(){return{title:"File",group:"premium",icon:"file",documentation:"http://help.form.io/userguide/#file",weight:100,schema:n.schema()}}init(){super.init(),o=navigator.camera||void 0;const e="undefined"!=typeof FileReader,t=Boolean(window.FormData),i=!!window.XMLHttpRequest&&"upload"in new XMLHttpRequest;this.support={filereader:e,formdata:t,hasWarning:!e||!t||!i,progress:i},this.filesReady=new a((e,t)=>{this.filesReadyResolve=e,this.filesReadyReject=t}),this.cameraMode=!1,this.statuses=[]}get dataReady(){return this.filesReady}get defaultSchema(){return n.schema()}loadImage(e){return this.fileService.downloadFile(e).then(e=>e.url)}get emptyValue(){return[]}getValueAsString(e){return s.isArray(e)?s.map(e,"originalName").join(", "):s.get(e,"originalName","")}getValue(){return this.dataValue}get defaultValue(){const e=super.defaultValue;return Array.isArray(e)?e:[]}get hasTypes(){return this.component.fileTypes&&Array.isArray(this.component.fileTypes)&&0!==this.component.fileTypes.length&&(""!==this.component.fileTypes[0].label||""!==this.component.fileTypes[0].value)}get fileService(){if(this.options.fileService)return this.options.fileService;if(this.options.formio)return this.options.formio;if(this.root&&this.root.formio)return this.root.formio;const e=new r;return this.root&&this.root._form&&this.root._form._id&&(e.formUrl=`${e.projectUrl}/form/${this.root._form._id}`),e}render(){return super.render(this.renderTemplate("file",{fileSize:this.fileSize,files:this.dataValue||[],statuses:this.statuses,disabled:this.disabled,support:this.support}))}getVideoStream(e){return navigator.mediaDevices.getUserMedia({video:{width:{min:640,ideal:1920},height:{min:360,ideal:1080},aspectRatio:{ideal:16/9},...e},audio:!1})}stopVideoStream(e){e.getVideoTracks().forEach(e=>e.stop())}getFrame(e){return new a(t=>{const i=document.createElement("canvas");i.height=e.videoHeight,i.width=e.videoWidth,i.getContext("2d").drawImage(e,0,0),i.toBlob(t)})}startVideo(){this.getVideoStream().then(e=>{this.videoStream=e;const{videoPlayer:t}=this.refs;if(!t)return console.warn("Video player not found in template."),this.cameraMode=!1,void this.redraw();t.srcObject=e;const i=parseInt(this.component.webcamSize)||320;t.setAttribute("width",i),t.play()}).catch(e=>{console.error(e),this.cameraMode=!1,this.redraw()})}stopVideo(){this.videoStream&&(this.stopVideoStream(this.videoStream),this.videoStream=null)}takePicture(){const{videoPlayer:e}=this.refs;if(!e)return console.warn("Video player not found in template."),this.cameraMode=!1,void this.redraw();this.getFrame(e).then(e=>{e.name=`photo-${Date.now()}.png`,this.upload([e]),this.cameraMode=!1,this.redraw()})}browseFiles(e={}){return new a(t=>{const i=this.ce("input",{type:"file",style:"height: 0; width: 0; visibility: hidden;",tabindex:"-1",...e});document.body.appendChild(i),i.addEventListener("change",()=>{t(i.files),document.body.removeChild(i)},!0),"function"==typeof i.trigger?i.trigger("click"):i.click()})}set cameraMode(e){this._cameraMode=e,e?this.startVideo():this.stopVideo()}get cameraMode(){return this._cameraMode}get useWebViewCamera(){return this.imageUpload&&o}get imageUpload(){return Boolean(this.component.image)}get browseOptions(){const e={};return this.component.multiple&&(e.multiple=!0),this.imageUpload&&(e.accept="image/*"),e}deleteFile(e){if(e&&"url"===this.component.storage){const t=this.fileService;if(t&&"function"==typeof t.deleteFile)t.deleteFile(e);else{const t=this.options.formio||this.root&&this.root.formio;t&&t.makeRequest("",e.url,"delete")}}}attach(e){this.loadRefs(e,{fileDrop:"single",fileBrowse:"single",galleryButton:"single",cameraButton:"single",takePictureButton:"single",toggleCameraMode:"single",videoPlayer:"single",fileLink:"multiple",removeLink:"multiple",fileStatusRemove:"multiple",fileImage:"multiple",fileType:"multiple"}),this.refs.input=[];const t=super.attach(e);if(this.refs.fileDrop){const e=this;this.addEventListener(this.refs.fileDrop,"dragover",function(e){this.className="fileSelector fileDragOver",e.preventDefault()}),this.addEventListener(this.refs.fileDrop,"dragleave",function(e){this.className="fileSelector",e.preventDefault()}),this.addEventListener(this.refs.fileDrop,"drop",function(t){return this.className="fileSelector",t.preventDefault(),e.upload(t.dataTransfer.files),!1})}if(this.refs.fileBrowse&&this.addEventListener(this.refs.fileBrowse,"click",e=>{e.preventDefault(),this.browseFiles(this.browseOptions).then(e=>{this.upload(e)})}),this.refs.fileLink.forEach((e,t)=>{this.addEventListener(e,"click",e=>{e.preventDefault(),this.getFile(this.dataValue[t])})}),this.refs.removeLink.forEach((e,t)=>{this.addEventListener(e,"click",e=>{const i=this.dataValue[t];this.deleteFile(i),e.preventDefault(),this.splice(t),this.redraw()})}),this.refs.fileStatusRemove.forEach((e,t)=>{this.addEventListener(e,"click",e=>{e.preventDefault(),this.statuses.splice(t,1),this.redraw()})}),this.refs.galleryButton&&o&&this.addEventListener(this.refs.galleryButton,"click",e=>{e.preventDefault(),o.getPicture(e=>{window.resolveLocalFileSystemURL(e,e=>{e.file(e=>{this.upload([e])})})},e=>{console.error(e)},{sourceType:o.PictureSourceType.PHOTOLIBRARY})}),this.refs.cameraButton&&o&&this.addEventListener(this.refs.cameraButton,"click",e=>{e.preventDefault(),o.getPicture(e=>{window.resolveLocalFileSystemURL(e,e=>{e.file(e=>{this.upload([e])})})},e=>{console.error(e)},{sourceType:o.PictureSourceType.CAMERA,encodingType:o.EncodingType.PNG,mediaType:o.MediaType.PICTURE,saveToPhotoAlbum:!0,correctOrientation:!1})}),this.refs.takePictureButton&&this.addEventListener(this.refs.takePictureButton,"click",e=>{e.preventDefault(),this.takePicture()}),this.refs.toggleCameraMode&&this.addEventListener(this.refs.toggleCameraMode,"click",e=>{e.preventDefault(),this.cameraMode=!this.cameraMode,this.redraw()}),this.refs.fileType.forEach((e,t)=>{this.dataValue[t].fileType=this.component.fileTypes[0].label,this.addEventListener(e,"change",e=>{e.preventDefault();const i=this.component.fileTypes.find(t=>t.value===e.target.value);this.dataValue[t].fileType=i.label})}),this.fileService){const e=[];this.refs.fileImage.forEach((t,i)=>{e.push(this.loadImage(this.dataValue[i]).then(e=>t.src=e))}),e.length&&a.all(e).then(()=>{this.filesReadyResolve()}).catch(()=>this.filesReadyReject())}return t}fileSize(e,t,i,s,r){return`${(t=Math,i=t.log,s=1024,r=i(e)/i(s)|0,e/t.pow(s,r)).toFixed(2)} ${r?`${"kMGTPEZY"[--r]}B`:"Bytes"}`}globStringToRegex(e){let t="",i=[];if(e.length>2&&"/"===e[0]&&"/"===e[e.length-1])t=e.substring(1,e.length-1);else{const s=e.split(",");if(s.length>1)for(let e=0;e<s.length;e++){const r=this.globStringToRegex(s[e]);r.regexp?(t+=`(${r.regexp})`,e<s.length-1&&(t+="|")):i=i.concat(r.excludes)}else e.startsWith("!")?i.push(`^((?!${this.globStringToRegex(e.substring(1)).regexp}).)*$`):(e.startsWith(".")&&(e=`*${e}`),t=(t=`^${e.replace(new RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\-]","g"),"\\$&")}$`).replace(/\\\*/g,".*").replace(/\\\?/g,"."))}return{regexp:t,excludes:i}}translateScalars(e){if("string"==typeof e){if(e.search(/kb/i)===e.length-2)return parseFloat(1024*e.substring(0,e.length-2));if(e.search(/mb/i)===e.length-2)return parseFloat(1024*e.substring(0,e.length-2)*1024);if(e.search(/gb/i)===e.length-2)return parseFloat(1024*e.substring(0,e.length-2)*1024*1024);if(e.search(/b/i)===e.length-1)return parseFloat(e.substring(0,e.length-1));if(e.search(/s/i)===e.length-1)return parseFloat(e.substring(0,e.length-1));if(e.search(/m/i)===e.length-1)return parseFloat(60*e.substring(0,e.length-1));if(e.search(/h/i)===e.length-1)return parseFloat(3600*e.substring(0,e.length-1))}return e}validatePattern(e,t){if(!t)return!0;const i=this.globStringToRegex(t);let r=!0;if(i.regexp&&i.regexp.length){const t=new RegExp(i.regexp,"i");r=!s.isNil(e.type)&&t.test(e.type)||!s.isNil(e.name)&&t.test(e.name)}return r=i.excludes.reduce((t,i)=>{const r=new RegExp(i,"i");return t&&(s.isNil(e.type)||!r.test(e.type))&&(s.isNil(e.name)||!r.test(e.name))},r)}validateMinSize(e,t){return e.size+.1>=this.translateScalars(t)}validateMaxSize(e,t){return e.size-.1<=this.translateScalars(t)}upload(e){this.component.multiple||(e=Array.prototype.slice.call(e,0,1)),this.component.storage&&e&&e.length&&Array.prototype.forEach.call(e,e=>{const i=t.uniqueName(e.name,this.component.fileNameTemplate,this.evalContext()),s={originalName:e.name,name:i,size:e.size,status:"info",message:this.t("Starting upload")};this.component.filePattern&&!this.validatePattern(e,this.component.filePattern)&&(s.status="error",s.message=this.t("File is the wrong type; it must be {{ pattern }}",{pattern:this.component.filePattern})),this.component.fileMinSize&&!this.validateMinSize(e,this.component.fileMinSize)&&(s.status="error",s.message=this.t("File is too small; it must be at least {{ size }}",{size:this.component.fileMinSize})),this.component.fileMaxSize&&!this.validateMaxSize(e,this.component.fileMaxSize)&&(s.status="error",s.message=this.t("File is too big; it must be at most {{ size }}",{size:this.component.fileMaxSize}));const r=this.interpolate(this.component.dir||""),{fileService:a}=this;if(a||(s.status="error",s.message=this.t("File Service not provided.")),this.statuses.push(s),this.redraw(),"error"!==s.status){this.component.privateDownload&&(e.private=!0);const{storage:t,options:o={}}=this.component,n=this.interpolate(this.component.url),l=this.component.fileKey||"file";a.uploadFile(t,e,i,r,e=>{s.status="progress",s.progress=parseInt(100*e.loaded/e.total),delete s.message,this.redraw()},n,o,l).then(t=>{const i=this.statuses.indexOf(s);-1!==i&&this.statuses.splice(i,1),t.originalName=e.name,this.hasValue()||(this.dataValue=[]),this.dataValue.push(t),this.redraw(),this.triggerChange()}).catch(e=>{s.status="error",s.message=e,delete s.progress,this.redraw()})}})}getFile(e){const{options:t={}}=this.component,{fileService:s}=this;if(!s)return alert("File Service not provided");this.component.privateDownload&&(e.private=!0),s.downloadFile(e,t).then(e=>{e&&(["base64","indexeddb"].includes(e.storage)?i(e.url,e.originalName||e.name,e.type):window.open(e.url,"_blank"))}).catch(e=>{alert(e)})}focus(){this.refs.fileBrowse&&this.refs.fileBrowse.focus()}}});
//# sourceMappingURL=../../sourcemaps/components/file/File.js.map
